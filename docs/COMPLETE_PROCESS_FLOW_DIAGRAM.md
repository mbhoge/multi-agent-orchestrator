# Complete Process Flow Diagram - Multi-Agent Orchestrator

## Comprehensive Visual Representation with Prompt Management & Observability

---

## ğŸ¯ Complete System Architecture Flow

### Flow 1: Direct REST API Request (API Gateway â†’ Lambda)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CLIENT / EXTERNAL REQUEST                                           â”‚
â”‚                                                                                                         â”‚
â”‚  POST https://<api-gateway-url>/api/v1/query                                                          â”‚
â”‚  {                                                                                                      â”‚
â”‚    "query": "What are the total sales for Q4 2024?",                                                   â”‚
â”‚    "session_id": "session-123",                                                                        â”‚
â”‚    "context": {"data_type": "structured"},                                                              â”‚
â”‚    "agent_preference": "market_segment",                                                               â”‚
â”‚    "metadata": {"user_id": "user-789", "request_source": "web_app"}                                  â”‚
â”‚  }                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTPS Request
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS API GATEWAY (HTTP API)                                                 â•‘    â”‚
â”‚  â•‘                    Route: POST /api/v1/query â†’ Lambda Integration                             â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  API Gateway Processing                                                                      â”‚      â”‚
â”‚  â”‚  â€¢ Request validation                                                                        â”‚      â”‚
â”‚  â”‚  â€¢ CORS handling                                                                             â”‚      â”‚
â”‚  â”‚  â€¢ Rate limiting                                                                             â”‚      â”‚
â”‚  â”‚  â€¢ Request transformation                                                                    â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: API Gateway request count                                                      â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "API Gateway received request: /api/v1/query"                                       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Lambda Invocation                                                                â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS LAMBDA: Query Handler                                                  â•‘    â”‚
â”‚  â•‘                    aws_agent_core/lambda_handlers/query_handler.py                          â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Lambda Handler Processing                                                                   â”‚      â”‚
â”‚  â”‚  lambda_handler(event, context)                                                               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 1: Parse API Gateway Event                                                             â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  parse_api_gateway_event(event)                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Extract: body, headers, path, method, query params                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Handle CORS preflight (OPTIONS)                                         â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 2: Extract AgentRequest                                                                â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  extract_agent_request_from_event(event)                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Parse JSON body                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Build AgentRequest object                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Validate required fields                                                â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: Lambda invocation count                                                         â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Lambda query_handler invoked: session_id={session_id}"                            â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE: Lambda request ID logged                                                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Get Orchestrator Instance                                                        â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  MultiAgentOrchestrator.process_request()                                                    â”‚      â”‚
â”‚  â”‚  aws_agent_core/orchestrator.py                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE START: "orchestrate_request"                                                       â”‚      â”‚
â”‚  â”‚     trace_id: "orchestrate_request_1705312345678"                                            â”‚      â”‚
â”‚  â”‚     metadata: {session_id, query}                                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 0: Prompt Management                                                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  _get_orchestrator_prompt()                                                                 â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“‹ PROMPT REQUEST:                                                                          â”‚      â”‚
â”‚  â”‚     â†’ langfuse.prompt_manager.get_prompt("orchestrator_query")                              â”‚      â”‚
â”‚  â”‚     â†’ HTTP GET http://langfuse:3000/api/public/prompts?name=orchestrator_query               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ PROMPT RENDER:                                                                            â”‚      â”‚
â”‚  â”‚     Template: "You are a multi-agent orchestrator. Process: {query}"                        â”‚      â”‚
â”‚  â”‚     Variables: {query, session_id, context}                                                  â”‚      â”‚
â”‚  â”‚     â†’ Enhanced Query: "You are a multi-agent orchestrator. Process: What are sales?"        â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                           â”‚      â”‚
â”‚  â”‚     - Prompt fetch time logged                                                               â”‚      â”‚
â”‚  â”‚     - Prompt cache hit/miss tracked                                                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Enhanced Query Applied                                                          â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 1: Invoke LangGraph                                                                    â”‚      â”‚
â”‚  â”‚  _invoke_langgraph(request, session_id)                                                      â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸŒ HTTP POST Request:                                                                        â”‚      â”‚
â”‚  â”‚     URL: http://langgraph:8001/supervisor/process                                              â”‚      â”‚
â”‚  â”‚     Timeout: 300s                                                                             â”‚      â”‚
â”‚  â”‚     Payload: {                                                                                â”‚      â”‚
â”‚  â”‚       "query": "Enhanced query...",                                                           â”‚      â”‚
â”‚  â”‚       "session_id": "session-123",                                                            â”‚      â”‚
â”‚  â”‚       "context": {"data_type": "structured"},                                                 â”‚      â”‚
â”‚  â”‚       "agent_preference": "market_segment"                                                    â”‚      â”‚
â”‚  â”‚     }                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: langgraph.invocation.start                                                       â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE: HTTP call logged with request/response                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP POST (httpx.AsyncClient)                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    LANGGRAPH SUPERVISOR (Port 8001)                                          â•‘    â”‚
â”‚  â•‘                    langgraph/supervisor.py                                                    â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  LangGraph Supervisor Endpoint (Internal Service)                                           â”‚      â”‚
â”‚  â”‚  HTTP POST http://langgraph:8001/supervisor/process                                           â”‚      â”‚
â”‚  â”‚  â†’ process_supervisor_request()                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Processing request in LangGraph supervisor: session=session-123"                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Convert to AgentRequest                                                         â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  LangGraphSupervisor.process_request()                                                        â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 1: State Management                                                                    â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  state_manager.get_state(session_id)                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Retrieve existing state OR create new state                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  State Object:                                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session_id": "session-123",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "query": "What are sales?",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "status": RequestStatus.PROCESSING,                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "current_step": "routing",                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "metadata": {...}                                                       â”‚             â”‚
â”‚  â”‚  â”‚  }                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - State retrieval/creation logged                                                        â”‚      â”‚
â”‚  â”‚     - State update tracked                                                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ State Updated: status=PROCESSING, current_step="routing"                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 2: Prompt Management for Routing                                                      â”‚      â”‚
â”‚  â”‚  langfuse_client.get_prompt_for_routing(query, context)                                      â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Prompt Manager Flow:                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  1. Check Cache: prompt_cache["supervisor_routing:latest"]                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Cache Hit: Return cached prompt                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Cache Miss: Continue to fetch                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  2. Fetch from Langfuse:                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     HTTP GET http://langfuse:3000/api/public/prompts?name=supervisor_routingâ”‚            â”‚      â”‚
â”‚  â”‚  â”‚     Headers: {                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "Authorization": "Bearer {secret_key}",                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "X-Langfuse-Public-Key": "{public_key}"                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  3. Prompt Data Received:                                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     {                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "name": "supervisor_routing",                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "prompt": "Analyze query: {query}\nContext: {context}",              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "version": 2,                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "config": {...},                                                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "labels": ["production"]                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  4. Render Prompt:                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     Variables: {query: "What are sales?", context: "{'data_type': 'structured'}"}â”‚      â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Rendered: "Analyze query: What are sales?\nContext: {'data_type': 'structured'}"â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  5. Cache Prompt: prompt_cache["supervisor_routing:latest"] = prompt_data  â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Prompt fetch time: 45ms                                                                â”‚      â”‚
â”‚  â”‚     - Cache hit/miss: tracked                                                                â”‚      â”‚
â”‚  â”‚     - Prompt version: logged                                                                â”‚      â”‚
â”‚  â”‚     - Langfuse API call: logged                                                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Rendered Prompt: "Analyze query: What are sales?..."                          â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 3: Agent Routing                                                                      â”‚      â”‚
â”‚  â”‚  agent_router.route_request(routing_prompt, context, agent_preference)                      â”‚      â”‚
â”‚  â”‚  langgraph/reasoning/router.py                                                               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Routing Decision Logic:                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  1. Analyze Query:                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Query type detection (structured vs unstructured)                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Context analysis (data_type, time_range, etc.)                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Agent preference consideration                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  2. Routing Decision:                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     {                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "selected_agent": "MARKET_SEGMENT_AGENT",                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "routing_reason": "Query requires structured data analysis",        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "confidence": 0.95                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  3. Update State:                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     state_manager.update_state(session_id, {                               â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "selected_agent": "MARKET_SEGMENT_AGENT",                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "routing_reason": "Query requires structured data",                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "current_step": "agent_invocation"                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     })                                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Routing decision logged                                                                â”‚      â”‚
â”‚  â”‚     - Confidence score tracked                                                               â”‚      â”‚
â”‚  â”‚     - Routing time measured                                                                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Routing Decision: market_segment (confidence: 0.95)                              â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 4: Memory Management                                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Short-Term Memory (Session-Level)                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  short_term_memory.store(session_id, "last_query", query)                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  short_term_memory.store(session_id, "routing_decision", decision)         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Memory Structure:                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session-123": {                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "last_query": "What are sales?",                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "routing_decision": {...},                                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "timestamp": "2024-01-15T10:30:00Z"                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    }                                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Memory operations logged                                                               â”‚      â”‚
â”‚  â”‚     - Memory size tracked                                                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Memory Stored                                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 5: Invoke Snowflake Agent                                                              â”‚      â”‚
â”‚  â”‚  _invoke_snowflake_agent(agent_name, query, session_id, context)                            â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸŒ HTTP POST Request:                                                                        â”‚      â”‚
â”‚  â”‚     URL: http://snowflake-cortex:8002/agents/invoke                                          â”‚      â”‚
â”‚  â”‚     Timeout: 300s                                                                             â”‚      â”‚
â”‚  â”‚     Payload: {                                                                                â”‚      â”‚
â”‚  â”‚       "agent_name": "YOUR_ANALYST_AGENT_NAME",                                                 â”‚      â”‚
â”‚  â”‚       "query": "What are the total sales for Q4 2024?",                                        â”‚      â”‚
â”‚  â”‚       "session_id": "session-123",                                                            â”‚      â”‚
â”‚  â”‚       "context": {"data_type": "structured"}                                                 â”‚      â”‚
â”‚  â”‚     }                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: snowflake.agent.invocation.start                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE: HTTP call logged                                                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP POST (httpx.AsyncClient)                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘              SNOWFLAKE CORTEX AI AGENT GATEWAY (Port 8002)                                   â•‘    â”‚
â”‚  â•‘              snowflake_cortex/gateway/agent_gateway.py                                       â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Agent Gateway Processing                                                                   â”‚      â”‚
â”‚  â”‚  â†’ Routes to Cortex Analyst Agent                                                          â”‚      â”‚
â”‚  â”‚  â†’ Executes SQL query via semantic model                                                    â”‚      â”‚
â”‚  â”‚  â†’ Returns structured response                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY (TruLens):                                                                â”‚      â”‚
â”‚  â”‚     - Agent evaluation logged                                                               â”‚      â”‚
â”‚  â”‚     - Response quality metrics                                                               â”‚      â”‚
â”‚  â”‚     - Feedback collection                                                                   â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Response:                                                                                    â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "sources": [                                                                               â”‚      â”‚
â”‚  â”‚      {                                                                                         â”‚      â”‚
â”‚  â”‚        "type": "database",                                                                    â”‚      â”‚
â”‚  â”‚        "reference": "sales_fact_table",                                                       â”‚      â”‚
â”‚  â”‚        "query": "SELECT SUM(amount) FROM sales_fact WHERE quarter='Q4' AND year=2024"      â”‚      â”‚
â”‚  â”‚      }                                                                                         â”‚      â”‚
â”‚  â”‚    ],                                                                                          â”‚      â”‚
â”‚  â”‚    "confidence": 0.98,                                                                        â”‚      â”‚
â”‚  â”‚    "execution_time": 0.85                                                                     â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP Response                                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    LANGGRAPH SUPERVISOR (Response Processing)                                â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 6: Update State with Response                                                         â”‚      â”‚
â”‚  â”‚  state_manager.update_state(session_id, {                                                     â”‚      â”‚
â”‚  â”‚    "status": RequestStatus.COMPLETED,                                                         â”‚      â”‚
â”‚  â”‚    "final_response": agent_response.get("response"),                                         â”‚      â”‚
â”‚  â”‚    "current_step": "completed"                                                                â”‚      â”‚
â”‚  â”‚  })                                                                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 7: Long-Term Memory (if significant)                                      â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  if routing_decision.get("confidence", 0) > 0.8:                                           â”‚      â”‚
â”‚  â”‚    long_term_memory.store(                                                                  â”‚      â”‚
â”‚  â”‚      key=f"query_pattern_{session_id}",                                                      â”‚      â”‚
â”‚  â”‚      value={                                                                                 â”‚      â”‚
â”‚  â”‚        "query": "What are sales?",                                                           â”‚      â”‚
â”‚  â”‚        "agent": "market_segment",                                                            â”‚      â”‚
â”‚  â”‚        "success": True                                                                       â”‚      â”‚
â”‚  â”‚      }                                                                                        â”‚      â”‚
â”‚  â”‚    )                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                           â”‚      â”‚
â”‚  â”‚     - Long-term memory storage logged                                                        â”‚      â”‚
â”‚  â”‚     - Pattern learning tracked                                                               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 8: Langfuse Observability Logging                                        â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  langfuse_client.log_supervisor_decision()                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Langfuse Trace Logging:                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  HTTP POST http://langfuse:3000/api/public/traces                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Payload: {                                                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "type": "trace",                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "name": "langgraph_supervisor_decision",                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session_id": "session-123",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "input": "What are sales?",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "output": {                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "selected_agent": "MARKET_SEGMENT_AGENT",                               â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "routing_reason": "Query requires structured data",                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "confidence": 0.95                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    },                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "metadata": {                                                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "execution_time": 1.5,                                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "selected_agent": "MARKET_SEGMENT_AGENT",                               â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "confidence": 0.95                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    }                                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Headers: {                                                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "Authorization": "Bearer {secret_key}",                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "Content-Type": "application/json"                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Supervisor decision logged to Langfuse                                                 â”‚      â”‚
â”‚  â”‚     - Trace ID generated and stored                                                          â”‚      â”‚
â”‚  â”‚     - Full request/response cycle tracked                                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Response Prepared                                                               â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Return Response to AWS Agent Core                                                           â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "selected_agent": "MARKET_SEGMENT_AGENT",                                                   â”‚      â”‚
â”‚  â”‚    "routing_reason": "Query requires structured data analysis",                              â”‚      â”‚
â”‚  â”‚    "confidence": 0.95,                                                                        â”‚      â”‚
â”‚  â”‚    "sources": [...],                                                                          â”‚      â”‚
â”‚  â”‚    "execution_time": 1.5,                                                                     â”‚      â”‚
â”‚  â”‚    "session_id": "session-123"                                                                â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP Response                                                                    â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS AGENT CORE ORCHESTRATOR (Response Processing)                        â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 2: Extract Routing Decision                                                            â”‚      â”‚
â”‚  â”‚  selected_agent = langgraph_response.get("selected_agent")                                    â”‚      â”‚
â”‚  â”‚  routing_reason = langgraph_response.get("routing_reason")                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 3: Build Final Response                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  AgentResponse Construction                                                                 â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "session_id": "session-123",                                                               â”‚      â”‚
â”‚  â”‚    "agent_used": "MARKET_SEGMENT_AGENT",                                                       â”‚      â”‚
â”‚  â”‚    "confidence": 0.95,                                                                        â”‚      â”‚
â”‚  â”‚    "sources": [...],                                                                          â”‚      â”‚
â”‚  â”‚    "execution_time": 1.5,                                                                     â”‚      â”‚
â”‚  â”‚    "metadata": {                                                                               â”‚      â”‚
â”‚  â”‚      "trace_id": "orchestrate_request_1705312345678",                                         â”‚      â”‚
â”‚  â”‚      "routing_reason": "Query requires structured data",                                      â”‚      â”‚
â”‚  â”‚      "user_id": "user-789",                                                                    â”‚      â”‚
â”‚  â”‚      "request_source": "web_app"                                                               â”‚      â”‚
â”‚  â”‚    },                                                                                           â”‚      â”‚
â”‚  â”‚    "timestamp": "2024-01-15T10:30:01.500Z"                                                     â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 4: Observability & Metrics                                               â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ğŸ“Š METRICS COLLECTION:                                                                      â”‚      â”‚
â”‚  â”‚     metrics_collector.record_timing("request.processing", 1.5)                              â”‚      â”‚
â”‚  â”‚     metrics_collector.increment_counter("requests.success")                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE COMPLETION:                                                                         â”‚      â”‚
â”‚  â”‚     trace_context["duration"] = 1.5                                                           â”‚      â”‚
â”‚  â”‚     trace_context["status"] = "success"                                                       â”‚      â”‚
â”‚  â”‚     tracer.traces[trace_id] = trace_context                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Request processed successfully for session session-123"                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Return to Lambda Handler                                                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Lambda Response Formatting                                                                  â”‚      â”‚
â”‚  â”‚  create_api_gateway_response(200, response_dict)                                            â”‚      â”‚
â”‚  â”‚  â†’ Format as API Gateway Lambda response                                                     â”‚      â”‚
â”‚  â”‚  â†’ Add CORS headers if needed                                                                â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: Lambda duration logged                                                           â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Lambda query_handler completed: duration={duration}ms"                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Lambda Response                                                                  â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS API GATEWAY (Response Processing)                                    â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â€¢ Transform Lambda response to HTTP response                                                         â”‚
â”‚  â€¢ Add API Gateway headers                                                                             â”‚
â”‚  â€¢ Apply response transformation rules                                                                 â”‚
â”‚                                                                                                         â”‚
â”‚  ğŸ“Š METRICS: API Gateway response time logged                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ HTTP Response
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CLIENT / EXTERNAL RESPONSE                                          â”‚
â”‚                                                                                                         â”‚
â”‚  HTTP 200 OK                                                                                            â”‚
â”‚  {                                                                                                      â”‚
â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                                  â”‚
â”‚    "session_id": "session-123",                                                                         â”‚
â”‚    "agent_used": "MARKET_SEGMENT_AGENT",                                                                â”‚
â”‚    "confidence": 0.95,                                                                                  â”‚
â”‚    "sources": [...],                                                                                    â”‚
â”‚    "execution_time": 1.5,                                                                               â”‚
â”‚    "metadata": {                                                                                        â”‚
â”‚      "trace_id": "orchestrate_request_1705312345678",                                                  â”‚
â”‚      "routing_reason": "Query requires structured data analysis"                                       â”‚
â”‚    },                                                                                                   â”‚
â”‚    "timestamp": "2024-01-15T10:30:01.500Z"                                                              â”‚
â”‚  }                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Flow 2: Microsoft Teams Outgoing Webhook Request

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MICROSOFT TEAMS CHANNEL                                                       â”‚
â”‚                                                                                                         â”‚
â”‚  User Action: @mention webhook in Teams channel                                                        â”‚
â”‚  Example: "@Multi-Agent Orchestrator What are the total sales for Q4 2024?"                          â”‚
â”‚                                                                                                         â”‚
â”‚  Teams Webhook Payload (Outgoing Webhook):                                                             â”‚
â”‚  {                                                                                                      â”‚
â”‚    "text": "What are the total sales for Q4 2024?",                                                    â”‚
â”‚    "from": {                                                                                            â”‚
â”‚      "id": "29:1abc123...",                                                                             â”‚
â”‚      "name": "John Doe"                                                                                 â”‚
â”‚    },                                                                                                   â”‚
â”‚    "channel": {                                                                                         â”‚
â”‚      "id": "19:channel123...",                                                                          â”‚
â”‚      "name": "General"                                                                                  â”‚
â”‚    },                                                                                                   â”‚
â”‚    "tenant": {                                                                                           â”‚
â”‚      "id": "tenant-123"                                                                                 â”‚
â”‚    }                                                                                                    â”‚
â”‚  }                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTPS POST Request
                                 â”‚ (with HMAC signature in Authorization header)
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS API GATEWAY (HTTP API)                                                 â•‘    â”‚
â”‚  â•‘                    Route: POST /api/teams/webhook â†’ Lambda Integration                          â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  API Gateway Processing                                                                      â”‚      â”‚
â”‚  â”‚  â€¢ Route to Teams webhook handler Lambda                                                     â”‚      â”‚
â”‚  â”‚  â€¢ Pass through headers (including Authorization for HMAC)                                   â”‚      â”‚
â”‚  â”‚  â€¢ CORS handling                                                                             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: API Gateway request count (Teams webhook)                                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Lambda Invocation                                                                â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS LAMBDA: Teams Webhook Handler                                         â•‘    â”‚
â”‚  â•‘                    aws_agent_core/lambda_handlers/teams_webhook_handler.py                  â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Lambda Handler Processing                                                                   â”‚      â”‚
â”‚  â”‚  lambda_handler(event, context)                                                               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 1: Parse API Gateway Event                                                             â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  parse_api_gateway_event(event)                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Extract: body (raw string), headers, path                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Preserve raw body for HMAC verification                                 â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 2: HMAC Signature Verification                                                         â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  verify_teams_webhook_signature(body, signature, secret)                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  1. Extract signature from Authorization header                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ headers.get("authorization") or headers.get("x-teams-signature")     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  2. Get webhook secret from environment                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ settings.teams.teams_app_password (configured in Teams)             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  3. Compute expected signature:                                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     HMAC-SHA256(secret, body) â†’ base64 encode                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  4. Constant-time comparison:                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     hmac.compare_digest(signature, expected_signature)                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  âœ“ If invalid: Return 401 Unauthorized                                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  âœ“ If valid: Continue processing                                           â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š SECURITY: HMAC verification prevents unauthorized requests                              â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Teams webhook signature verified: channel_id={channel_id}"                        â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 3: Parse Teams Webhook Payload                                                         â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Parse JSON body                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Extract: text (user message), from, channel, tenant                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Validate required fields                                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  If text is empty:                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    â†’ Return: {"text": "Please provide a query or question."}               â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 4: Transform Teams Webhook to AgentRequest                                             â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  TeamsMessageTransformer.teams_to_agent_request(webhook_data)            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Build context from Teams metadata:                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "source": "microsoft_teams_webhook",                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "channel_id": webhook_data["channel"]["id"],                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "channel_name": webhook_data["channel"]["name"],                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "user_id": webhook_data["from"]["id"],                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "user_name": webhook_data["from"]["name"],                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "tenant_id": webhook_data["tenant"]["id"]                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Create session ID:                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    session_id = f"teams_webhook_{channel_id}_{user_id}"                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Build AgentRequest:                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "query": webhook_data["text"],                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session_id": session_id,                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "context": context,                                                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "agent_preference": None,  # Can extract from message if needed         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "metadata": {                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "teams_webhook": True,                                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "webhook_data": webhook_data                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    }                                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Teams webhook transformed: query={query}, session_id={session_id}"                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Process through Orchestrator (same flow as REST API)                            â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  MultiAgentOrchestrator.process_request(agent_request)                                      â”‚      â”‚
â”‚  â”‚  â†’ [Same flow as Flow 1: Orchestrator â†’ LangGraph â†’ Snowflake â†’ Response]                   â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Returns: AgentResponse                                                                       â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "session_id": "teams_webhook_channel123_user123",                                         â”‚      â”‚
â”‚  â”‚    "agent_used": "MARKET_SEGMENT_AGENT",                                                       â”‚      â”‚
â”‚  â”‚    "confidence": 0.95,                                                                        â”‚      â”‚
â”‚  â”‚    "sources": [...],                                                                          â”‚      â”‚
â”‚  â”‚    "execution_time": 1.5                                                                      â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Format Response for Teams                                                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 5: Format Teams Webhook Response                                                        â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Teams outgoing webhooks expect simple JSON with "text" field:            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  response_text = agent_response.response                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  # Add metadata if available                                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  if agent_response.confidence:                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    response_text += f"\n\n_Confidence: {confidence * 100:.1f}%_"         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  if agent_response.sources:                                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    response_text += f"\n\n_Sources: {len(sources)}_"                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  teams_response = {                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "text": response_text                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Note: Teams outgoing webhooks have limited formatting support.           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  For richer responses (Adaptive Cards), use Bot Framework instead.         â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Teams webhook response formatted: session_id={session_id}"                        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Return Lambda Response                                                            â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  create_api_gateway_response(200, teams_response)                                          â”‚      â”‚
â”‚  â”‚  â†’ Format as API Gateway Lambda response                                                     â”‚      â”‚
â”‚  â”‚  â†’ Content-Type: application/json                                                            â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: Lambda duration logged                                                         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Lambda Response                                                                  â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS API GATEWAY (Response Processing)                                    â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â€¢ Transform Lambda response to HTTP response                                                         â”‚
â”‚  â€¢ Return to Teams                                                                                    â”‚
â”‚                                                                                                         â”‚
â”‚  ğŸ“Š METRICS: API Gateway response time logged                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ HTTP Response
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MICROSOFT TEAMS CHANNEL (Response Display)                                    â”‚
â”‚                                                                                                         â”‚
â”‚  Teams displays the response in the channel:                                                           â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Multi-Agent Orchestrator                                                   â”‚                      â”‚
â”‚  â”‚                                                                              â”‚                      â”‚
â”‚  â”‚  Total sales for Q4 2024: $5,234,567                                        â”‚                      â”‚
â”‚  â”‚                                                                              â”‚                      â”‚
â”‚  â”‚  _Confidence: 95.0%_                                                        â”‚                      â”‚
â”‚  â”‚  _Sources: 1_                                                               â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                                                         â”‚
â”‚  ğŸ“Š OBSERVABILITY:                                                                                     â”‚
â”‚  â€¢ Teams webhook request logged                                                                         â”‚
â”‚  â€¢ HMAC verification tracked                                                                          â”‚
â”‚  â€¢ Response delivery confirmed                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Observability & Logging Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          OBSERVABILITY LAYER                                                 â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   AWS CLOUDWATCH      â”‚  â”‚   AWS X-RAY          â”‚  â”‚   LANGFUSE           â”‚          â”‚
â”‚  â”‚   (Lambda + API GW)   â”‚  â”‚   (Distributed)     â”‚  â”‚   (LangGraph)        â”‚          â”‚
â”‚  â”‚                        â”‚  â”‚                      â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚  â€¢ Lambda Logs        â”‚  â”‚  â€¢ Request Tracing   â”‚  â”‚  â€¢ Supervisor Logs   â”‚          â”‚
â”‚  â”‚  â€¢ API Gateway Logs   â”‚  â”‚  â€¢ Service Map       â”‚  â”‚  â€¢ Prompt Managementâ”‚          â”‚
â”‚  â”‚  â€¢ Metrics            â”‚  â”‚  â€¢ Performance       â”‚  â”‚  â€¢ State Updates    â”‚          â”‚
â”‚  â”‚  â€¢ Alarms             â”‚  â”‚  â€¢ Error Analysis    â”‚  â”‚  â€¢ Routing Decisions â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   TRULENS            â”‚  â”‚   APPLICATION LOGS  â”‚  â”‚   STATE TRACKING     â”‚          â”‚
â”‚  â”‚   (Snowflake Agents)  â”‚  â”‚   (All Services)     â”‚  â”‚   (LangGraph)        â”‚          â”‚
â”‚  â”‚                        â”‚  â”‚                      â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚  â€¢ Agent Evaluation   â”‚  â”‚  â€¢ Request/Response â”‚  â”‚  â€¢ Session State      â”‚          â”‚
â”‚  â”‚  â€¢ Response Quality   â”‚  â”‚  â€¢ Error Logs       â”‚  â”‚  â€¢ Step Tracking      â”‚          â”‚
â”‚  â”‚  â€¢ Feedback Collectionâ”‚  â”‚  â€¢ Debug Info       â”‚  â”‚  â€¢ Status Updates     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                               â”‚
â”‚  Observability Data Flow:                                                                    â”‚
â”‚  â€¢ Lambda â†’ CloudWatch Logs: All handler execution logs                                      â”‚
â”‚  â€¢ API Gateway â†’ CloudWatch Logs: Access logs, execution logs                                â”‚
â”‚  â€¢ Lambda â†’ X-Ray: Trace segments (if X-Ray enabled)                                        â”‚
â”‚  â€¢ LangGraph â†’ Langfuse: Supervisor decisions, prompts, traces                              â”‚
â”‚  â€¢ Snowflake â†’ TruLens: Agent evaluation, feedback                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Prompt Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROMPT MANAGEMENT SYSTEM                                                 â”‚
â”‚                                                                                               â”‚
â”‚  Request Flow:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. Prompt Request                                                          â”‚             â”‚
â”‚  â”‚     get_prompt("prompt_name")                                              â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  2. Cache Check                                                            â”‚             â”‚
â”‚  â”‚     prompt_cache["prompt_name:latest"]                                    â”‚             â”‚
â”‚  â”‚     â†’ Cache Hit: Return immediately                                        â”‚             â”‚
â”‚  â”‚     â†’ Cache Miss: Continue to fetch                                        â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  3. Langfuse API Call                                                       â”‚             â”‚
â”‚  â”‚     HTTP GET http://langfuse:3000/api/public/prompts?name=prompt_name     â”‚             â”‚
â”‚  â”‚     Headers: Authorization, X-Langfuse-Public-Key                          â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  4. Prompt Data Received                                                    â”‚             â”‚
â”‚  â”‚     {                                                                       â”‚             â”‚
â”‚  â”‚       "name": "prompt_name",                                               â”‚             â”‚
â”‚  â”‚       "prompt": "Template with {variables}",                               â”‚             â”‚
â”‚  â”‚       "version": 2,                                                        â”‚             â”‚
â”‚  â”‚       "config": {...},                                                     â”‚             â”‚
â”‚  â”‚       "labels": ["production"]                                             â”‚             â”‚
â”‚  â”‚     }                                                                       â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  5. Cache Storage                                                          â”‚             â”‚
â”‚  â”‚     prompt_cache["prompt_name:latest"] = prompt_data                      â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  6. Prompt Rendering                                                       â”‚             â”‚
â”‚  â”‚     render_prompt(template, variables)                                      â”‚             â”‚
â”‚  â”‚     â†’ Replace {variable} with actual values                               â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  7. Return Rendered Prompt                                                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Prompt Types:                                                                                â”‚
â”‚  â€¢ orchestrator_query: Initial query enhancement                                             â”‚
â”‚  â€¢ supervisor_routing: Agent routing decision                                                â”‚
â”‚  â€¢ agent_response: Agent response generation                                                 â”‚
â”‚  â€¢ analyst_tool: Structured analysis tool (semantic model / SQL)                              â”‚
â”‚  â€¢ search_tool: Unstructured search tool (search service / docs)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Data Transformations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA TRANSFORMATION PIPELINE                                          â”‚
â”‚                                                                                               â”‚
â”‚  Original Query:                                                                              â”‚
â”‚  "What are the total sales for Q4 2024?"                                                      â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Prompt Enhancement (Orchestrator)                                         â”‚             â”‚
â”‚  â”‚  Template: "You are a multi-agent orchestrator. Process: {query}"         â”‚             â”‚
â”‚  â”‚  Result: "You are a multi-agent orchestrator. Process: What are sales?"   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Routing Prompt (LangGraph)                                                 â”‚             â”‚
â”‚  â”‚  Template: "Analyze query: {query}\nContext: {context}"                    â”‚             â”‚
â”‚  â”‚  Result: "Analyze query: What are sales?\nContext: {'data_type': 'structured'}"â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Routing Decision                                                          â”‚             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "selected_agent": "MARKET_SEGMENT_AGENT",                                 â”‚             â”‚
â”‚  â”‚    "routing_reason": "Query requires structured data",                   â”‚             â”‚
â”‚  â”‚    "confidence": 0.95                                                      â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Agent Query (Snowflake)                                                    â”‚             â”‚
â”‚  â”‚  Original query passed to agent with context                               â”‚             â”‚
â”‚  â”‚  â†’ SQL Conversion: "SELECT SUM(amount) FROM sales_fact..."                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  Final Response:                                                                               â”‚
â”‚  "Total sales for Q4 2024: $5,234,567"                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Metrics & Observability Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBSERVABILITY CHECKPOINTS                                                 â”‚
â”‚                                                                                               â”‚
â”‚  Entry Point (API Gateway):                                                                  â”‚
â”‚  âœ“ Request received (timestamp, path, method, IP address)                                    â”‚
â”‚  âœ“ API Gateway metrics: request count, latency, error rate                                   â”‚
â”‚  âœ“ CloudWatch Logs: API Gateway access logs                                                  â”‚
â”‚  âœ“ X-Ray tracing: Request ID generated (if enabled)                                          â”‚
â”‚                                                                                               â”‚
â”‚  Lambda Handler (Query/Teams Webhook):                                                       â”‚
â”‚  âœ“ Lambda invocation (request ID, duration, memory used)                                     â”‚
â”‚  âœ“ CloudWatch Logs: Lambda execution logs                                                    â”‚
â”‚  âœ“ Error tracking: Lambda errors logged to CloudWatch                                       â”‚
â”‚  âœ“ Teams webhook: HMAC verification success/failure logged                                 â”‚
â”‚                                                                                               â”‚
â”‚  Orchestrator:                                                                                â”‚
â”‚  âœ“ Trace start: orchestrate_request                                                          â”‚
â”‚  âœ“ Prompt fetch: orchestrator_query (time, cache_hit/miss)                                   â”‚
â”‚  âœ“ LangGraph invocation: HTTP call (request_time, response_time)                             â”‚
â”‚  âœ“ Trace completion: duration, status                                                         â”‚
â”‚  âœ“ Metrics: requests.success/error, request.processing.timing                                â”‚
â”‚                                                                                               â”‚
â”‚  LangGraph Supervisor:                                                                        â”‚
â”‚  âœ“ State retrieval/creation (time)                                                           â”‚
â”‚  âœ“ Prompt fetch: supervisor_routing (time, version)                                         â”‚
â”‚  âœ“ Routing decision: agent, confidence, reason                                               â”‚
â”‚  âœ“ Memory operations: short_term.store, long_term.store                                      â”‚
â”‚  âœ“ Snowflake invocation: HTTP call (time, success/failure)                                    â”‚
â”‚  âœ“ Langfuse logging: supervisor_decision (trace_id, metadata)                                â”‚
â”‚                                                                                               â”‚
â”‚  Snowflake Agent:                                                                             â”‚
â”‚  âœ“ TruLens evaluation: response quality, feedback                                            â”‚
â”‚  âœ“ Agent execution: SQL query time, result size                                              â”‚
â”‚                                                                                               â”‚
â”‚  Exit Point (API Gateway + Lambda):                                                          â”‚
â”‚  âœ“ Lambda response formatted and returned                                                    â”‚
â”‚  âœ“ API Gateway response sent (timestamp, total_duration)                                     â”‚
â”‚  âœ“ Final metrics updated (CloudWatch, X-Ray)                                                 â”‚
â”‚                                                                                               â”‚
â”‚  AWS Observability Stack:                                                                     â”‚
â”‚  â€¢ CloudWatch Logs: All Lambda and API Gateway logs                                         â”‚
â”‚  â€¢ CloudWatch Metrics: Lambda duration, errors, API Gateway latency                          â”‚
â”‚  â€¢ AWS X-Ray: Distributed tracing across services (if enabled)                                 â”‚
â”‚  â€¢ CloudWatch Alarms: Error rate, latency thresholds                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE LIFECYCLE                                                           â”‚
â”‚                                                                                               â”‚
â”‚  State Creation:                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  state_manager.create_state()                                              â”‚             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "session_id": "session-123",                                            â”‚             â”‚
â”‚  â”‚    "query": "What are sales?",                                             â”‚             â”‚
â”‚  â”‚    "status": RequestStatus.PENDING,                                        â”‚             â”‚
â”‚  â”‚    "current_step": "initialization",                                       â”‚             â”‚
â”‚  â”‚    "metadata": {...}                                                       â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  State Updates:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. PROCESSING: status=PROCESSING, current_step="routing"                â”‚             â”‚
â”‚  â”‚  2. ROUTING: selected_agent, routing_reason, current_step="agent_invocation"â”‚            â”‚
â”‚  â”‚  3. COMPLETED: status=COMPLETED, final_response, current_step="completed"  â”‚             â”‚
â”‚  â”‚  4. FAILED: status=FAILED, error message (if error occurs)                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  State Retrieval:                                                                             â”‚
â”‚  â€¢ get_state(session_id) â†’ Returns current state for session                                  â”‚
â”‚  â€¢ Used for conversation context and stateful interactions                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Memory Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MEMORY LAYERS                                                             â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  SHORT-TERM MEMORY (Session-Level)                                          â”‚             â”‚
â”‚  â”‚  â€¢ Stored per session_id                                                     â”‚             â”‚
â”‚  â”‚  â€¢ TTL: Session duration                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Stores:                                                                   â”‚             â”‚
â”‚  â”‚    - last_query                                                              â”‚             â”‚
â”‚  â”‚    - routing_decision                                                         â”‚             â”‚
â”‚  â”‚    - conversation context                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Used for: Current conversation context                                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  LONG-TERM MEMORY (Persistent)                                               â”‚             â”‚
â”‚  â”‚  â€¢ Stored across sessions                                                    â”‚             â”‚
â”‚  â”‚  â€¢ TTL: Indefinite (or configurable retention)                              â”‚             â”‚
â”‚  â”‚  â€¢ Stores:                                                                   â”‚             â”‚
â”‚  â”‚    - query_pattern_{session_id}                                              â”‚             â”‚
â”‚  â”‚    - agent preferences                                                       â”‚             â”‚
â”‚  â”‚    - successful routing patterns                                             â”‚             â”‚
â”‚  â”‚  â€¢ Used for: Learning and pattern recognition                                 â”‚             â”‚
â”‚  â”‚  â€¢ Trigger: confidence > 0.8                                                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Visual Summary

### REST API Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE REQUEST LIFECYCLE (REST API)                                    â”‚
â”‚                                                                                               â”‚
â”‚  CLIENT / WEB APP                                                                            â”‚
â”‚    â”‚                                                                                           â”‚
â”‚    â”‚ POST https://api-gateway-url/api/v1/query                                                â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS API GATEWAY                                                                             â”‚
â”‚    â”‚ â€¢ Route to Lambda                                                                        â”‚
â”‚    â”‚ â€¢ Request transformation                                                                 â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS LAMBDA (Query Handler)                                                                  â”‚
â”‚    â”‚ â€¢ Parse API Gateway event                                                                â”‚
â”‚    â”‚ â€¢ Extract AgentRequest                                                                   â”‚
â”‚    â”‚ â€¢ Invoke Orchestrator                                                                    â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS AGENT CORE ORCHESTRATOR                                                                  â”‚
â”‚    â”‚ â€¢ Trace Start                                                                            â”‚
â”‚    â”‚ â€¢ Prompt: orchestrator_query                                                            â”‚
â”‚    â”‚ â€¢ HTTP â†’ LangGraph                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  LANGGRAPH SUPERVISOR                                                                         â”‚
â”‚    â”‚ â€¢ State Management                                                                       â”‚
â”‚    â”‚ â€¢ Prompt: supervisor_routing                                                            â”‚
â”‚    â”‚ â€¢ Agent Routing                                                                          â”‚
â”‚    â”‚ â€¢ Memory: Short-term                                                                     â”‚
â”‚    â”‚ â€¢ HTTP â†’ Snowflake                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  SNOWFLAKE AGENT                                                                              â”‚
â”‚    â”‚ â€¢ Agent Execution                                                                        â”‚
â”‚    â”‚ â€¢ TruLens Evaluation                                                                     â”‚
â”‚    â”‚ â€¢ Response Generation                                                                     â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  LANGGRAPH SUPERVISOR                                                                         â”‚
â”‚    â”‚ â€¢ State Update: COMPLETED                                                                â”‚
â”‚    â”‚ â€¢ Memory: Long-term (if confidence > 0.8)                                               â”‚
â”‚    â”‚ â€¢ Langfuse Logging                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS AGENT CORE ORCHESTRATOR                                                                  â”‚
â”‚    â”‚ â€¢ Trace Completion                                                                        â”‚
â”‚    â”‚ â€¢ Metrics Update                                                                          â”‚
â”‚    â”‚ â€¢ Response Construction                                                                   â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS LAMBDA (Query Handler)                                                                  â”‚
â”‚    â”‚ â€¢ Format API Gateway response                                                             â”‚
â”‚    â”‚ â€¢ Return to API Gateway                                                                  â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS API GATEWAY                                                                             â”‚
â”‚    â”‚ â€¢ Transform Lambda response                                                               â”‚
â”‚    â”‚ â€¢ Return HTTP response                                                                   â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  CLIENT / WEB APP                                                                            â”‚
â”‚    â”‚ HTTP 200 OK + Response                                                                    â”‚
â”‚    â–¼                                                                                           â”‚
â”‚                                                                                               â”‚
â”‚  OBSERVABILITY (Throughout):                                                                  â”‚
â”‚  â€¢ AWS CloudWatch: Lambda logs, API Gateway logs                                             â”‚
â”‚  â€¢ AWS X-Ray: Distributed tracing (if enabled)                                                â”‚
â”‚  â€¢ Langfuse: Supervisor decisions, prompts                                                   â”‚
â”‚  â€¢ Metrics: Counters, timings, success/error rates                                            â”‚
â”‚  â€¢ TruLens: Agent evaluation                                                                  â”‚
â”‚                                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Microsoft Teams Webhook Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE REQUEST LIFECYCLE (TEAMS WEBHOOK)                               â”‚
â”‚                                                                                               â”‚
â”‚  MICROSOFT TEAMS CHANNEL                                                                     â”‚
â”‚    â”‚                                                                                           â”‚
â”‚    â”‚ User: @Multi-Agent Orchestrator What are sales?                                          â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  TEAMS OUTGOING WEBHOOK                                                                      â”‚
â”‚    â”‚ â€¢ Generate HMAC signature                                                                 â”‚
â”‚    â”‚ â€¢ POST to API Gateway                                                                     â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS API GATEWAY                                                                             â”‚
â”‚    â”‚ â€¢ Route to Teams webhook Lambda                                                           â”‚
â”‚    â”‚ â€¢ Pass through headers (HMAC)                                                             â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS LAMBDA (Teams Webhook Handler)                                                          â”‚
â”‚    â”‚ â€¢ Verify HMAC signature                                                                   â”‚
â”‚    â”‚ â€¢ Parse Teams webhook payload                                                            â”‚
â”‚    â”‚ â€¢ Transform to AgentRequest                                                              â”‚
â”‚    â”‚ â€¢ Invoke Orchestrator                                                                     â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS AGENT CORE ORCHESTRATOR                                                                 â”‚
â”‚    â”‚ â€¢ [Same flow as REST API]                                                                 â”‚
â”‚    â”‚ â€¢ Process through LangGraph â†’ Snowflake                                                  â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS LAMBDA (Teams Webhook Handler)                                                          â”‚
â”‚    â”‚ â€¢ Format Teams webhook response                                                           â”‚
â”‚    â”‚ â€¢ Return JSON with "text" field                                                          â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS API GATEWAY                                                                             â”‚
â”‚    â”‚ â€¢ Return HTTP response                                                                    â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  TEAMS OUTGOING WEBHOOK                                                                      â”‚
â”‚    â”‚ â€¢ Receive response                                                                        â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  MICROSOFT TEAMS CHANNEL                                                                     â”‚
â”‚    â”‚ Display response in channel                                                                â”‚
â”‚    â–¼                                                                                           â”‚
â”‚                                                                                               â”‚
â”‚  SECURITY & OBSERVABILITY:                                                                   â”‚
â”‚  â€¢ HMAC signature verification (prevents unauthorized requests)                            â”‚
â”‚  â€¢ AWS CloudWatch: Lambda logs, API Gateway logs                                             â”‚
â”‚  â€¢ Teams webhook request/response tracking                                                    â”‚
â”‚                                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Microsoft Teams Outgoing Webhook Details

### Webhook Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TEAMS OUTGOING WEBHOOK SETUP                                             â”‚
â”‚                                                                                               â”‚
â”‚  Configuration Steps:                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. Create Outgoing Webhook in Teams                                       â”‚             â”‚
â”‚  â”‚     â€¢ Navigate to channel â†’ Connectors â†’ Outgoing Webhook                 â”‚             â”‚
â”‚  â”‚     â€¢ Name: "Multi-Agent Orchestrator"                                    â”‚             â”‚
â”‚  â”‚     â€¢ Callback URL: https://<api-gateway-url>/api/teams/webhook           â”‚             â”‚             â”‚
â”‚  â”‚     â€¢ Description: "AI-powered data query assistant"                     â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  2. Save Security Token                                                    â”‚             â”‚
â”‚  â”‚     â€¢ Teams generates a unique security token                               â”‚             â”‚
â”‚  â”‚     â€¢ âš ï¸ Save immediately - cannot be retrieved later                      â”‚             â”‚
â”‚  â”‚     â€¢ Configure in Lambda: TEAMS_APP_PASSWORD environment variable        â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  3. Configure Lambda Environment                                           â”‚             â”‚
â”‚  â”‚     â€¢ Set TEAMS_APP_PASSWORD = <webhook-security-token>                   â”‚             â”‚
â”‚  â”‚     â€¢ Or use AWS Secrets Manager (recommended for production)              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Webhook Properties:                                                                          â”‚
â”‚  â€¢ Webhook URL: Unique URL for @mentioning the webhook                                       â”‚
â”‚  â€¢ Security Token: Used for HMAC signature verification                                      â”‚
â”‚  â€¢ Callback URL: API Gateway endpoint for receiving requests                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HMAC Signature Verification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HMAC SIGNATURE VERIFICATION PROCESS                                      â”‚
â”‚                                                                                               â”‚
â”‚  Teams Side (Request Generation):                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. Teams creates webhook payload (JSON body)                              â”‚             â”‚
â”‚  â”‚  2. Teams computes HMAC signature:                                          â”‚             â”‚
â”‚  â”‚     signature = base64(HMAC-SHA256(security_token, body))                  â”‚             â”‚
â”‚  â”‚  3. Teams sends POST request with:                                         â”‚             â”‚
â”‚  â”‚     â€¢ Body: JSON payload                                                    â”‚             â”‚
â”‚  â”‚     â€¢ Header: Authorization: Bearer <signature>                             â”‚             â”‚
â”‚  â”‚     â€¢ Header: X-Teams-Signature: <signature> (alternative)                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â”‚ HTTPS POST Request                                                                  â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  Lambda Side (Verification):                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. Receive request from API Gateway                                       â”‚             â”‚
â”‚  â”‚  2. Extract raw body (preserve original for HMAC)                         â”‚             â”‚
â”‚  â”‚  3. Extract signature from Authorization or X-Teams-Signature header     â”‚             â”‚
â”‚  â”‚  4. Get security token from environment (TEAMS_APP_PASSWORD)              â”‚             â”‚
â”‚  â”‚  5. Compute expected signature:                                            â”‚             â”‚
â”‚  â”‚     expected = base64(HMAC-SHA256(security_token, raw_body))                â”‚             â”‚
â”‚  â”‚  6. Compare signatures (constant-time):                                    â”‚             â”‚
â”‚  â”‚     hmac.compare_digest(signature, expected)                                â”‚             â”‚
â”‚  â”‚  7. If match: Continue processing                                          â”‚             â”‚
â”‚  â”‚     If mismatch: Return 401 Unauthorized                                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Security Benefits:                                                                          â”‚
â”‚  â€¢ Prevents unauthorized requests (only Teams with correct token can call)                   â”‚
â”‚  â€¢ Ensures request integrity (body cannot be tampered with)                                 â”‚
â”‚  â€¢ Constant-time comparison prevents timing attacks                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Message Transformation Details

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TEAMS WEBHOOK â†’ AGENT REQUEST TRANSFORMATION                            â”‚
â”‚                                                                                               â”‚
â”‚  Input: Teams Outgoing Webhook Payload                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "text": "What are the total sales for Q4 2024?",                        â”‚             â”‚
â”‚  â”‚    "from": {                                                                â”‚             â”‚
â”‚  â”‚      "id": "29:1abc123...",                                                 â”‚             â”‚
â”‚  â”‚      "name": "John Doe"                                                      â”‚             â”‚
â”‚  â”‚    },                                                                       â”‚             â”‚
â”‚  â”‚    "channel": {                                                             â”‚             â”‚
â”‚  â”‚      "id": "19:channel123...",                                              â”‚             â”‚
â”‚  â”‚      "name": "General"                                                       â”‚             â”‚
â”‚  â”‚    },                                                                       â”‚             â”‚
â”‚  â”‚    "tenant": {                                                              â”‚             â”‚
â”‚  â”‚      "id": "tenant-123"                                                      â”‚             â”‚
â”‚  â”‚    }                                                                        â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â”‚ Transformation Logic                                                                â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  Output: AgentRequest                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "query": "What are the total sales for Q4 2024?",                       â”‚             â”‚
â”‚  â”‚    "session_id": "teams_webhook_19:channel123..._29:1abc123...",          â”‚             â”‚
â”‚  â”‚    "context": {                                                             â”‚             â”‚
â”‚  â”‚      "source": "microsoft_teams_webhook",                                   â”‚             â”‚
â”‚  â”‚      "channel_id": "19:channel123...",                                      â”‚             â”‚
â”‚  â”‚      "channel_name": "General",                                             â”‚             â”‚
â”‚  â”‚      "user_id": "29:1abc123...",                                            â”‚             â”‚
â”‚  â”‚      "user_name": "John Doe",                                               â”‚             â”‚
â”‚  â”‚      "tenant_id": "tenant-123"                                              â”‚             â”‚
â”‚  â”‚    },                                                                       â”‚             â”‚
â”‚  â”‚    "agent_preference": null,  # Can be extracted from message if needed    â”‚             â”‚
â”‚  â”‚    "metadata": {                                                            â”‚             â”‚
â”‚  â”‚      "teams_webhook": true,                                                  â”‚             â”‚
â”‚  â”‚      "webhook_data": {...}  # Original Teams payload                        â”‚             â”‚
â”‚  â”‚    }                                                                        â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Key Transformations:                                                                        â”‚
â”‚  â€¢ text â†’ query: User message becomes the query                                              â”‚
â”‚  â€¢ channel_id + user_id â†’ session_id: Unique session per channel-user pair                  â”‚
â”‚  â€¢ Teams metadata â†’ context: Preserves Teams context for routing/analytics                  â”‚
â”‚  â€¢ Original payload â†’ metadata: Keeps full Teams context for debugging                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Response Formatting for Teams

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AGENT RESPONSE â†’ TEAMS WEBHOOK RESPONSE                                   â”‚
â”‚                                                                                               â”‚
â”‚  Input: AgentResponse                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                      â”‚             â”‚
â”‚  â”‚    "session_id": "teams_webhook_...",                                       â”‚             â”‚
â”‚  â”‚    "agent_used": "MARKET_SEGMENT_AGENT",                                    â”‚             â”‚
â”‚  â”‚    "confidence": 0.95,                                                      â”‚             â”‚
â”‚  â”‚    "sources": [...],                                                        â”‚             â”‚
â”‚  â”‚    "execution_time": 1.5                                                    â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â”‚ Formatting Logic                                                                    â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  Output: Teams Webhook Response                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "text": "Total sales for Q4 2024: $5,234,567\n\n_Confidence: 95.0%_\n\n_Sources: 1_"â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Formatting Rules:                                                                            â”‚
â”‚  â€¢ Main response text: Direct answer to user query                                           â”‚
â”‚  â€¢ Confidence: Added as italic text if available                                              â”‚
â”‚  â€¢ Sources: Count displayed if sources are present                                           â”‚
â”‚  â€¢ Markdown: Limited support (italic, bold, code blocks)                                      â”‚
â”‚  â€¢ Adaptive Cards: Not supported in outgoing webhooks (use Bot Framework for rich cards)   â”‚
â”‚                                                                                               â”‚
â”‚  Teams Display:                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Multi-Agent Orchestrator                                                   â”‚             â”‚
â”‚  â”‚                                                                              â”‚             â”‚
â”‚  â”‚  Total sales for Q4 2024: $5,234,567                                        â”‚             â”‚
â”‚  â”‚                                                                              â”‚             â”‚
â”‚  â”‚  _Confidence: 95.0%_                                                        â”‚             â”‚
â”‚  â”‚  _Sources: 1_                                                               â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Legend

- **ğŸ“Š METRICS**: Performance and operational metrics
- **ğŸ” TRACE**: Distributed tracing information
- **ğŸ“ LOG**: Application logging
- **ğŸ“‹ PROMPT**: Prompt management operations
- **ğŸ’¾ MEMORY**: Memory storage operations
- **ğŸ”„ STATE**: State management operations
- **ğŸŒ HTTP**: HTTP communication
- **âœ“**: Observability checkpoint

---

## ğŸ—ï¸ Architecture Summary

### Serverless Architecture (AWS Lambda + API Gateway)

The system uses a **serverless architecture** with AWS Lambda functions and API Gateway, replacing the previous FastAPI-based approach:

- **Entry Point**: AWS API Gateway HTTP API
- **Request Handlers**: AWS Lambda functions (query_handler, teams_webhook_handler)
- **Orchestration**: AWS Agent Core Runtime SDK (invoked from Lambda)
- **Multi-Agent Supervisor**: LangGraph (internal service)
- **Agent Execution**: Snowflake Cortex AI Agents (via REST API)

### Key Benefits

1. **Scalability**: Auto-scaling Lambda functions based on request volume
2. **Cost Efficiency**: Pay only for actual request processing time
3. **High Availability**: Managed AWS infrastructure with built-in redundancy
4. **Security**: HMAC verification for Teams webhooks, IAM-based access control
5. **Observability**: CloudWatch Logs, Metrics, and X-Ray integration

### Integration Points

- **REST API**: Direct HTTP requests to `/api/v1/query` endpoint
- **Microsoft Teams**: Outgoing webhooks via `/api/teams/webhook` endpoint
- **Internal Services**: LangGraph supervisor and Snowflake Cortex Gateway (HTTP)

---

This comprehensive diagram shows the complete flow including:
- **Two request flows**: REST API and Microsoft Teams webhook
- **Serverless architecture**: AWS Lambda + API Gateway
- **Security**: HMAC signature verification for Teams webhooks
- **Data transformations**: Teams webhook â†’ AgentRequest â†’ AgentResponse â†’ Teams response
- **Prompt management**: Langfuse integration for dynamic prompts
- **Observability**: CloudWatch, X-Ray, Langfuse, and TruLens
- **State management**: Session-based state and memory operations
- **Multi-agent orchestration**: LangGraph supervisor routing to domain-specific Snowflake agents



