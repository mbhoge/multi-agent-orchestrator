# Complete Process Flow Diagram - Multi-Agent Orchestrator

## Comprehensive Visual Representation with Prompt Management & Observability

---

## ğŸ¯ Complete System Architecture Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CLIENT / EXTERNAL REQUEST                                           â”‚
â”‚                                                                                                         â”‚
â”‚  POST /api/v1/query                                                                                    â”‚
â”‚  {                                                                                                      â”‚
â”‚    "query": "What are the total sales for Q4 2024?",                                                   â”‚
â”‚    "session_id": "session-123",                                                                        â”‚
â”‚    "context": {"data_type": "structured"},                                                              â”‚
â”‚    "agent_preference": "cortex_analyst",                                                               â”‚
â”‚    "metadata": {"user_id": "user-789", "request_source": "web_app"}                                  â”‚
â”‚  }                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP Request
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS AGENT CORE ORCHESTRATOR (Port 8000)                                    â•‘    â”‚
â”‚  â•‘                    aws_agent_core/api/routes.py                                                â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  FastAPI Route Handler                                                                      â”‚      â”‚
â”‚  â”‚  @router.post("/query")                                                                      â”‚      â”‚
â”‚  â”‚  â†’ process_query()                                                                           â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: requests.total++                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Received query request: {query[:100]}"                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Dependency Injection: get_orchestrator()                                         â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  MultiAgentOrchestrator.process_request()                                                    â”‚      â”‚
â”‚  â”‚  aws_agent_core/orchestrator.py                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE START: "orchestrate_request"                                                       â”‚      â”‚
â”‚  â”‚     trace_id: "orchestrate_request_1705312345678"                                            â”‚      â”‚
â”‚  â”‚     metadata: {session_id, query}                                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 0: Prompt Management                                                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  _get_orchestrator_prompt()                                                                 â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“‹ PROMPT REQUEST:                                                                          â”‚      â”‚
â”‚  â”‚     â†’ langfuse.prompt_manager.get_prompt("orchestrator_query")                              â”‚      â”‚
â”‚  â”‚     â†’ HTTP GET http://langfuse:3000/api/public/prompts?name=orchestrator_query               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ PROMPT RENDER:                                                                            â”‚      â”‚
â”‚  â”‚     Template: "You are a multi-agent orchestrator. Process: {query}"                        â”‚      â”‚
â”‚  â”‚     Variables: {query, session_id, context}                                                  â”‚      â”‚
â”‚  â”‚     â†’ Enhanced Query: "You are a multi-agent orchestrator. Process: What are sales?"        â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                           â”‚      â”‚
â”‚  â”‚     - Prompt fetch time logged                                                               â”‚      â”‚
â”‚  â”‚     - Prompt cache hit/miss tracked                                                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Enhanced Query Applied                                                          â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 1: Invoke LangGraph                                                                    â”‚      â”‚
â”‚  â”‚  _invoke_langgraph(request, session_id)                                                      â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸŒ HTTP POST Request:                                                                        â”‚      â”‚
â”‚  â”‚     URL: http://langgraph:8001/supervisor/process                                              â”‚      â”‚
â”‚  â”‚     Timeout: 300s                                                                             â”‚      â”‚
â”‚  â”‚     Payload: {                                                                                â”‚      â”‚
â”‚  â”‚       "query": "Enhanced query...",                                                           â”‚      â”‚
â”‚  â”‚       "session_id": "session-123",                                                            â”‚      â”‚
â”‚  â”‚       "context": {"data_type": "structured"},                                                 â”‚      â”‚
â”‚  â”‚       "agent_preference": "cortex_analyst"                                                    â”‚      â”‚
â”‚  â”‚     }                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: langgraph.invocation.start                                                       â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE: HTTP call logged with request/response                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP POST (httpx.AsyncClient)                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    LANGGRAPH SUPERVISOR (Port 8001)                                          â•‘    â”‚
â”‚  â•‘                    langgraph/supervisor.py                                                    â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  FastAPI Endpoint                                                                           â”‚      â”‚
â”‚  â”‚  @app.post("/supervisor/process")                                                           â”‚      â”‚
â”‚  â”‚  â†’ process_supervisor_request()                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Processing request in LangGraph supervisor: session=session-123"                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Convert to AgentRequest                                                         â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  LangGraphSupervisor.process_request()                                                        â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Step 1: State Management                                                                    â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  state_manager.get_state(session_id)                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  â†’ Retrieve existing state OR create new state                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  State Object:                                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session_id": "session-123",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "query": "What are sales?",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "status": RequestStatus.PROCESSING,                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "current_step": "routing",                                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "metadata": {...}                                                       â”‚             â”‚
â”‚  â”‚  â”‚  }                                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - State retrieval/creation logged                                                        â”‚      â”‚
â”‚  â”‚     - State update tracked                                                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ State Updated: status=PROCESSING, current_step="routing"                       â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 2: Prompt Management for Routing                                                      â”‚      â”‚
â”‚  â”‚  langfuse_client.get_prompt_for_routing(query, context)                                      â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Prompt Manager Flow:                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  1. Check Cache: prompt_cache["supervisor_routing:latest"]                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Cache Hit: Return cached prompt                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Cache Miss: Continue to fetch                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  2. Fetch from Langfuse:                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     HTTP GET http://langfuse:3000/api/public/prompts?name=supervisor_routingâ”‚            â”‚      â”‚
â”‚  â”‚  â”‚     Headers: {                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "Authorization": "Bearer {secret_key}",                              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "X-Langfuse-Public-Key": "{public_key}"                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  3. Prompt Data Received:                                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     {                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "name": "supervisor_routing",                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "prompt": "Analyze query: {query}\nContext: {context}",              â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "version": 2,                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "config": {...},                                                     â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "labels": ["production"]                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  4. Render Prompt:                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     Variables: {query: "What are sales?", context: "{'data_type': 'structured'}"}â”‚      â”‚      â”‚
â”‚  â”‚  â”‚     â†’ Rendered: "Analyze query: What are sales?\nContext: {'data_type': 'structured'}"â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  5. Cache Prompt: prompt_cache["supervisor_routing:latest"] = prompt_data  â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Prompt fetch time: 45ms                                                                â”‚      â”‚
â”‚  â”‚     - Cache hit/miss: tracked                                                                â”‚      â”‚
â”‚  â”‚     - Prompt version: logged                                                                â”‚      â”‚
â”‚  â”‚     - Langfuse API call: logged                                                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Rendered Prompt: "Analyze query: What are sales?..."                          â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 3: Agent Routing                                                                      â”‚      â”‚
â”‚  â”‚  agent_router.route_request(routing_prompt, context, agent_preference)                      â”‚      â”‚
â”‚  â”‚  langgraph/reasoning/router.py                                                               â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Routing Decision Logic:                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  1. Analyze Query:                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Query type detection (structured vs unstructured)                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Context analysis (data_type, time_range, etc.)                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     - Agent preference consideration                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  2. Routing Decision:                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     {                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "selected_agent": AgentType.CORTEX_ANALYST,                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "routing_reason": "Query requires structured data analysis",        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "confidence": 0.95                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     }                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  3. Update State:                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     state_manager.update_state(session_id, {                               â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "selected_agent": "cortex_analyst",                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "routing_reason": "Query requires structured data",                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚       "current_step": "agent_invocation"                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚     })                                                                      â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Routing decision logged                                                                â”‚      â”‚
â”‚  â”‚     - Confidence score tracked                                                               â”‚      â”‚
â”‚  â”‚     - Routing time measured                                                                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Routing Decision: cortex_analyst (confidence: 0.95)                              â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 4: Memory Management                                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Short-Term Memory (Session-Level)                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  short_term_memory.store(session_id, "last_query", query)                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  short_term_memory.store(session_id, "routing_decision", decision)         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Memory Structure:                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  {                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session-123": {                                                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "last_query": "What are sales?",                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "routing_decision": {...},                                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "timestamp": "2024-01-15T10:30:00Z"                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    }                                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Memory operations logged                                                               â”‚      â”‚
â”‚  â”‚     - Memory size tracked                                                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Memory Stored                                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 5: Invoke Snowflake Agent                                                              â”‚      â”‚
â”‚  â”‚  _invoke_snowflake_agent(agent_name, query, session_id, context)                            â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸŒ HTTP POST Request:                                                                        â”‚      â”‚
â”‚  â”‚     URL: http://snowflake-cortex:8002/agents/invoke                                          â”‚      â”‚
â”‚  â”‚     Timeout: 300s                                                                             â”‚      â”‚
â”‚  â”‚     Payload: {                                                                                â”‚      â”‚
â”‚  â”‚       "agent_name": "YOUR_ANALYST_AGENT_NAME",                                                 â”‚      â”‚
â”‚  â”‚       "query": "What are the total sales for Q4 2024?",                                        â”‚      â”‚
â”‚  â”‚       "session_id": "session-123",                                                            â”‚      â”‚
â”‚  â”‚       "context": {"data_type": "structured"}                                                 â”‚      â”‚
â”‚  â”‚     }                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š METRICS: snowflake.agent.invocation.start                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE: HTTP call logged                                                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP POST (httpx.AsyncClient)                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘              SNOWFLAKE CORTEX AI AGENT GATEWAY (Port 8002)                                   â•‘    â”‚
â”‚  â•‘              snowflake_cortex/gateway/agent_gateway.py                                       â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Agent Gateway Processing                                                                   â”‚      â”‚
â”‚  â”‚  â†’ Routes to Cortex Analyst Agent                                                          â”‚      â”‚
â”‚  â”‚  â†’ Executes SQL query via semantic model                                                    â”‚      â”‚
â”‚  â”‚  â†’ Returns structured response                                                              â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY (TruLens):                                                                â”‚      â”‚
â”‚  â”‚     - Agent evaluation logged                                                               â”‚      â”‚
â”‚  â”‚     - Response quality metrics                                                               â”‚      â”‚
â”‚  â”‚     - Feedback collection                                                                   â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  Response:                                                                                    â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "sources": [                                                                               â”‚      â”‚
â”‚  â”‚      {                                                                                         â”‚      â”‚
â”‚  â”‚        "type": "database",                                                                    â”‚      â”‚
â”‚  â”‚        "reference": "sales_fact_table",                                                       â”‚      â”‚
â”‚  â”‚        "query": "SELECT SUM(amount) FROM sales_fact WHERE quarter='Q4' AND year=2024"      â”‚      â”‚
â”‚  â”‚      }                                                                                         â”‚      â”‚
â”‚  â”‚    ],                                                                                          â”‚      â”‚
â”‚  â”‚    "confidence": 0.98,                                                                        â”‚      â”‚
â”‚  â”‚    "execution_time": 0.85                                                                     â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP Response                                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    LANGGRAPH SUPERVISOR (Response Processing)                                â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 6: Update State with Response                                                         â”‚      â”‚
â”‚  â”‚  state_manager.update_state(session_id, {                                                     â”‚      â”‚
â”‚  â”‚    "status": RequestStatus.COMPLETED,                                                         â”‚      â”‚
â”‚  â”‚    "final_response": agent_response.get("response"),                                         â”‚      â”‚
â”‚  â”‚    "current_step": "completed"                                                                â”‚      â”‚
â”‚  â”‚  })                                                                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 7: Long-Term Memory (if significant)                                      â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  if routing_decision.get("confidence", 0) > 0.8:                                           â”‚      â”‚
â”‚  â”‚    long_term_memory.store(                                                                  â”‚      â”‚
â”‚  â”‚      key=f"query_pattern_{session_id}",                                                      â”‚      â”‚
â”‚  â”‚      value={                                                                                 â”‚      â”‚
â”‚  â”‚        "query": "What are sales?",                                                           â”‚      â”‚
â”‚  â”‚        "agent": "cortex_analyst",                                                             â”‚      â”‚
â”‚  â”‚        "success": True                                                                       â”‚      â”‚
â”‚  â”‚      }                                                                                        â”‚      â”‚
â”‚  â”‚    )                                                                                          â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                           â”‚      â”‚
â”‚  â”‚     - Long-term memory storage logged                                                        â”‚      â”‚
â”‚  â”‚     - Pattern learning tracked                                                               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 8: Langfuse Observability Logging                                        â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  langfuse_client.log_supervisor_decision()                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚  Langfuse Trace Logging:                                                   â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  HTTP POST http://langfuse:3000/api/public/traces                          â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Payload: {                                                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "type": "trace",                                                         â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "name": "langgraph_supervisor_decision",                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "session_id": "session-123",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "input": "What are sales?",                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "output": {                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "selected_agent": "cortex_analyst",                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "routing_reason": "Query requires structured data",                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "confidence": 0.95                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    },                                                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "metadata": {                                                            â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "execution_time": 1.5,                                                â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "selected_agent": "cortex_analyst",                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚      "confidence": 0.95                                                    â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    }                                                                        â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â”‚                                                                             â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  Headers: {                                                                 â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "Authorization": "Bearer {secret_key}",                                  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚    "Content-Type": "application/json"                                       â”‚             â”‚      â”‚
â”‚  â”‚  â”‚  }                                                                           â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“Š OBSERVABILITY:                                                                            â”‚      â”‚
â”‚  â”‚     - Supervisor decision logged to Langfuse                                                 â”‚      â”‚
â”‚  â”‚     - Trace ID generated and stored                                                          â”‚      â”‚
â”‚  â”‚     - Full request/response cycle tracked                                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Response Prepared                                                               â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Return Response to AWS Agent Core                                                           â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "selected_agent": "cortex_analyst",                                                        â”‚      â”‚
â”‚  â”‚    "routing_reason": "Query requires structured data analysis",                              â”‚      â”‚
â”‚  â”‚    "confidence": 0.95,                                                                        â”‚      â”‚
â”‚  â”‚    "sources": [...],                                                                          â”‚      â”‚
â”‚  â”‚    "execution_time": 1.5,                                                                     â”‚      â”‚
â”‚  â”‚    "session_id": "session-123"                                                                â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ HTTP Response                                                                    â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚  â•‘                    AWS AGENT CORE ORCHESTRATOR (Response Processing)                        â•‘    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Step 2: Extract Routing Decision                                                            â”‚      â”‚
â”‚  â”‚  selected_agent = langgraph_response.get("selected_agent")                                    â”‚      â”‚
â”‚  â”‚  routing_reason = langgraph_response.get("routing_reason")                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 3: Build Final Response                                                   â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  AgentResponse Construction                                                                 â”‚      â”‚
â”‚  â”‚  {                                                                                             â”‚      â”‚
â”‚  â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                        â”‚      â”‚
â”‚  â”‚    "session_id": "session-123",                                                               â”‚      â”‚
â”‚  â”‚    "agent_used": "cortex_analyst",                                                            â”‚      â”‚
â”‚  â”‚    "confidence": 0.95,                                                                        â”‚      â”‚
â”‚  â”‚    "sources": [...],                                                                          â”‚      â”‚
â”‚  â”‚    "execution_time": 1.5,                                                                     â”‚      â”‚
â”‚  â”‚    "metadata": {                                                                               â”‚      â”‚
â”‚  â”‚      "trace_id": "orchestrate_request_1705312345678",                                         â”‚      â”‚
â”‚  â”‚      "routing_reason": "Query requires structured data",                                      â”‚      â”‚
â”‚  â”‚      "user_id": "user-789",                                                                    â”‚      â”‚
â”‚  â”‚      "request_source": "web_app"                                                               â”‚      â”‚
â”‚  â”‚    },                                                                                           â”‚      â”‚
â”‚  â”‚    "timestamp": "2024-01-15T10:30:01.500Z"                                                     â”‚      â”‚
â”‚  â”‚  }                                                                                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Step 4: Observability & Metrics                                               â”‚
â”‚                     â–¼                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ğŸ“Š METRICS COLLECTION:                                                                      â”‚      â”‚
â”‚  â”‚     metrics_collector.record_timing("request.processing", 1.5)                              â”‚      â”‚
â”‚  â”‚     metrics_collector.increment_counter("requests.success")                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ” TRACE COMPLETION:                                                                         â”‚      â”‚
â”‚  â”‚     trace_context["duration"] = 1.5                                                           â”‚      â”‚
â”‚  â”‚     trace_context["status"] = "success"                                                       â”‚      â”‚
â”‚  â”‚     tracer.traces[trace_id] = trace_context                                                  â”‚      â”‚
â”‚  â”‚                                                                                               â”‚      â”‚
â”‚  â”‚  ğŸ“ LOG: "Request processed successfully for session session-123"                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                                                                  â”‚
â”‚                     â”‚ Final Response Ready                                                           â”‚
â”‚                     â–¼                                                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CLIENT / EXTERNAL RESPONSE                                          â”‚
â”‚                                                                                                         â”‚
â”‚  HTTP 200 OK                                                                                            â”‚
â”‚  {                                                                                                      â”‚
â”‚    "response": "Total sales for Q4 2024: $5,234,567",                                                  â”‚
â”‚    "session_id": "session-123",                                                                         â”‚
â”‚    "agent_used": "cortex_analyst",                                                                     â”‚
â”‚    "confidence": 0.95,                                                                                  â”‚
â”‚    "sources": [...],                                                                                    â”‚
â”‚    "execution_time": 1.5,                                                                               â”‚
â”‚    "metadata": {                                                                                        â”‚
â”‚      "trace_id": "orchestrate_request_1705312345678",                                                  â”‚
â”‚      "routing_reason": "Query requires structured data analysis"                                       â”‚
â”‚    },                                                                                                   â”‚
â”‚    "timestamp": "2024-01-15T10:30:01.500Z"                                                              â”‚
â”‚  }                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Observability & Logging Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          OBSERVABILITY LAYER                                                 â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   AWS TRACING          â”‚  â”‚   LANGFUSE           â”‚  â”‚   METRICS            â”‚          â”‚
â”‚  â”‚   (Agent Core)        â”‚  â”‚   (LangGraph)        â”‚  â”‚   (All Services)     â”‚          â”‚
â”‚  â”‚                        â”‚  â”‚                      â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚  â€¢ Trace Operations   â”‚  â”‚  â€¢ Supervisor Logs   â”‚  â”‚  â€¢ Request Counters  â”‚          â”‚
â”‚  â”‚  â€¢ HTTP Calls         â”‚  â”‚  â€¢ Prompt Managementâ”‚  â”‚  â€¢ Timing Metrics     â”‚          â”‚
â”‚  â”‚  â€¢ Error Tracking    â”‚  â”‚  â€¢ State Updates    â”‚  â”‚  â€¢ Error Rates        â”‚          â”‚
â”‚  â”‚  â€¢ Performance       â”‚  â”‚  â€¢ Routing Decisions â”‚  â”‚  â€¢ Success Rates      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   TRULENS            â”‚  â”‚   APPLICATION LOGS  â”‚  â”‚   STATE TRACKING     â”‚          â”‚
â”‚  â”‚   (Snowflake Agents)  â”‚  â”‚   (All Services)     â”‚  â”‚   (LangGraph)        â”‚          â”‚
â”‚  â”‚                        â”‚  â”‚                      â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚  â€¢ Agent Evaluation   â”‚  â”‚  â€¢ Request/Response â”‚  â”‚  â€¢ Session State      â”‚          â”‚
â”‚  â”‚  â€¢ Response Quality   â”‚  â”‚  â€¢ Error Logs       â”‚  â”‚  â€¢ Step Tracking      â”‚          â”‚
â”‚  â”‚  â€¢ Feedback Collectionâ”‚  â”‚  â€¢ Debug Info       â”‚  â”‚  â€¢ Status Updates     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Prompt Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROMPT MANAGEMENT SYSTEM                                                 â”‚
â”‚                                                                                               â”‚
â”‚  Request Flow:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. Prompt Request                                                          â”‚             â”‚
â”‚  â”‚     get_prompt("prompt_name")                                              â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  2. Cache Check                                                            â”‚             â”‚
â”‚  â”‚     prompt_cache["prompt_name:latest"]                                    â”‚             â”‚
â”‚  â”‚     â†’ Cache Hit: Return immediately                                        â”‚             â”‚
â”‚  â”‚     â†’ Cache Miss: Continue to fetch                                        â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  3. Langfuse API Call                                                       â”‚             â”‚
â”‚  â”‚     HTTP GET http://langfuse:3000/api/public/prompts?name=prompt_name     â”‚             â”‚
â”‚  â”‚     Headers: Authorization, X-Langfuse-Public-Key                          â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  4. Prompt Data Received                                                    â”‚             â”‚
â”‚  â”‚     {                                                                       â”‚             â”‚
â”‚  â”‚       "name": "prompt_name",                                               â”‚             â”‚
â”‚  â”‚       "prompt": "Template with {variables}",                               â”‚             â”‚
â”‚  â”‚       "version": 2,                                                        â”‚             â”‚
â”‚  â”‚       "config": {...},                                                     â”‚             â”‚
â”‚  â”‚       "labels": ["production"]                                             â”‚             â”‚
â”‚  â”‚     }                                                                       â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  5. Cache Storage                                                          â”‚             â”‚
â”‚  â”‚     prompt_cache["prompt_name:latest"] = prompt_data                      â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  6. Prompt Rendering                                                       â”‚             â”‚
â”‚  â”‚     render_prompt(template, variables)                                      â”‚             â”‚
â”‚  â”‚     â†’ Replace {variable} with actual values                               â”‚             â”‚
â”‚  â”‚                                                                             â”‚             â”‚
â”‚  â”‚  7. Return Rendered Prompt                                                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  Prompt Types:                                                                                â”‚
â”‚  â€¢ orchestrator_query: Initial query enhancement                                             â”‚
â”‚  â€¢ supervisor_routing: Agent routing decision                                                â”‚
â”‚  â€¢ agent_response: Agent response generation                                                 â”‚
â”‚  â€¢ snowflake_cortex_analyst: SQL query conversion                                             â”‚
â”‚  â€¢ snowflake_cortex_search: Document search                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Data Transformations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA TRANSFORMATION PIPELINE                                          â”‚
â”‚                                                                                               â”‚
â”‚  Original Query:                                                                              â”‚
â”‚  "What are the total sales for Q4 2024?"                                                      â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Prompt Enhancement (Orchestrator)                                         â”‚             â”‚
â”‚  â”‚  Template: "You are a multi-agent orchestrator. Process: {query}"         â”‚             â”‚
â”‚  â”‚  Result: "You are a multi-agent orchestrator. Process: What are sales?"   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Routing Prompt (LangGraph)                                                 â”‚             â”‚
â”‚  â”‚  Template: "Analyze query: {query}\nContext: {context}"                    â”‚             â”‚
â”‚  â”‚  Result: "Analyze query: What are sales?\nContext: {'data_type': 'structured'}"â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Routing Decision                                                          â”‚             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "selected_agent": "cortex_analyst",                                      â”‚             â”‚
â”‚  â”‚    "routing_reason": "Query requires structured data",                   â”‚             â”‚
â”‚  â”‚    "confidence": 0.95                                                      â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Agent Query (Snowflake)                                                    â”‚             â”‚
â”‚  â”‚  Original query passed to agent with context                               â”‚             â”‚
â”‚  â”‚  â†’ SQL Conversion: "SELECT SUM(amount) FROM sales_fact..."                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  Final Response:                                                                               â”‚
â”‚  "Total sales for Q4 2024: $5,234,567"                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Metrics & Observability Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBSERVABILITY CHECKPOINTS                                                 â”‚
â”‚                                                                                               â”‚
â”‚  Entry Point:                                                                                â”‚
â”‚  âœ“ Request received (timestamp, session_id, query_length)                                    â”‚
â”‚  âœ“ Metrics: requests.total++                                                                â”‚
â”‚                                                                                               â”‚
â”‚  Orchestrator:                                                                                â”‚
â”‚  âœ“ Trace start: orchestrate_request                                                          â”‚
â”‚  âœ“ Prompt fetch: orchestrator_query (time, cache_hit/miss)                                   â”‚
â”‚  âœ“ LangGraph invocation: HTTP call (request_time, response_time)                             â”‚
â”‚  âœ“ Trace completion: duration, status                                                         â”‚
â”‚  âœ“ Metrics: requests.success/error, request.processing.timing                                â”‚
â”‚                                                                                               â”‚
â”‚  LangGraph Supervisor:                                                                        â”‚
â”‚  âœ“ State retrieval/creation (time)                                                           â”‚
â”‚  âœ“ Prompt fetch: supervisor_routing (time, version)                                         â”‚
â”‚  âœ“ Routing decision: agent, confidence, reason                                               â”‚
â”‚  âœ“ Memory operations: short_term.store, long_term.store                                      â”‚
â”‚  âœ“ Snowflake invocation: HTTP call (time, success/failure)                                    â”‚
â”‚  âœ“ Langfuse logging: supervisor_decision (trace_id, metadata)                                â”‚
â”‚                                                                                               â”‚
â”‚  Snowflake Agent:                                                                             â”‚
â”‚  âœ“ TruLens evaluation: response quality, feedback                                            â”‚
â”‚  âœ“ Agent execution: SQL query time, result size                                              â”‚
â”‚                                                                                               â”‚
â”‚  Exit Point:                                                                                  â”‚
â”‚  âœ“ Response sent (timestamp, total_duration)                                                  â”‚
â”‚  âœ“ Final metrics updated                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE LIFECYCLE                                                           â”‚
â”‚                                                                                               â”‚
â”‚  State Creation:                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  state_manager.create_state()                                              â”‚             â”‚
â”‚  â”‚  {                                                                          â”‚             â”‚
â”‚  â”‚    "session_id": "session-123",                                            â”‚             â”‚
â”‚  â”‚    "query": "What are sales?",                                             â”‚             â”‚
â”‚  â”‚    "status": RequestStatus.PENDING,                                        â”‚             â”‚
â”‚  â”‚    "current_step": "initialization",                                       â”‚             â”‚
â”‚  â”‚    "metadata": {...}                                                       â”‚             â”‚
â”‚  â”‚  }                                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                                      â”‚
â”‚         â–¼                                                                                      â”‚
â”‚  State Updates:                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  1. PROCESSING: status=PROCESSING, current_step="routing"                â”‚             â”‚
â”‚  â”‚  2. ROUTING: selected_agent, routing_reason, current_step="agent_invocation"â”‚            â”‚
â”‚  â”‚  3. COMPLETED: status=COMPLETED, final_response, current_step="completed"  â”‚             â”‚
â”‚  â”‚  4. FAILED: status=FAILED, error message (if error occurs)                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  State Retrieval:                                                                             â”‚
â”‚  â€¢ get_state(session_id) â†’ Returns current state for session                                  â”‚
â”‚  â€¢ Used for conversation context and stateful interactions                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Memory Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MEMORY LAYERS                                                             â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  SHORT-TERM MEMORY (Session-Level)                                          â”‚             â”‚
â”‚  â”‚  â€¢ Stored per session_id                                                     â”‚             â”‚
â”‚  â”‚  â€¢ TTL: Session duration                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Stores:                                                                   â”‚             â”‚
â”‚  â”‚    - last_query                                                              â”‚             â”‚
â”‚  â”‚    - routing_decision                                                         â”‚             â”‚
â”‚  â”‚    - conversation context                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Used for: Current conversation context                                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  LONG-TERM MEMORY (Persistent)                                               â”‚             â”‚
â”‚  â”‚  â€¢ Stored across sessions                                                    â”‚             â”‚
â”‚  â”‚  â€¢ TTL: Indefinite (or configurable retention)                              â”‚             â”‚
â”‚  â”‚  â€¢ Stores:                                                                   â”‚             â”‚
â”‚  â”‚    - query_pattern_{session_id}                                              â”‚             â”‚
â”‚  â”‚    - agent preferences                                                       â”‚             â”‚
â”‚  â”‚    - successful routing patterns                                             â”‚             â”‚
â”‚  â”‚  â€¢ Used for: Learning and pattern recognition                                 â”‚             â”‚
â”‚  â”‚  â€¢ Trigger: confidence > 0.8                                                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Visual Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                               â”‚
â”‚                    COMPLETE REQUEST LIFECYCLE                                                â”‚
â”‚                                                                                               â”‚
â”‚  CLIENT                                                                                       â”‚
â”‚    â”‚                                                                                           â”‚
â”‚    â”‚ POST /api/v1/query                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS AGENT CORE                                                                               â”‚
â”‚    â”‚ â€¢ Trace Start                                                                            â”‚
â”‚    â”‚ â€¢ Prompt: orchestrator_query                                                            â”‚
â”‚    â”‚ â€¢ HTTP â†’ LangGraph                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  LANGGRAPH SUPERVISOR                                                                         â”‚
â”‚    â”‚ â€¢ State Management                                                                       â”‚
â”‚    â”‚ â€¢ Prompt: supervisor_routing                                                            â”‚
â”‚    â”‚ â€¢ Agent Routing                                                                          â”‚
â”‚    â”‚ â€¢ Memory: Short-term                                                                     â”‚
â”‚    â”‚ â€¢ HTTP â†’ Snowflake                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  SNOWFLAKE AGENT                                                                              â”‚
â”‚    â”‚ â€¢ Agent Execution                                                                        â”‚
â”‚    â”‚ â€¢ TruLens Evaluation                                                                     â”‚
â”‚    â”‚ â€¢ Response Generation                                                                     â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  LANGGRAPH SUPERVISOR                                                                         â”‚
â”‚    â”‚ â€¢ State Update: COMPLETED                                                                â”‚
â”‚    â”‚ â€¢ Memory: Long-term (if confidence > 0.8)                                               â”‚
â”‚    â”‚ â€¢ Langfuse Logging                                                                       â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  AWS AGENT CORE                                                                               â”‚
â”‚    â”‚ â€¢ Trace Completion                                                                        â”‚
â”‚    â”‚ â€¢ Metrics Update                                                                          â”‚
â”‚    â”‚ â€¢ Response Construction                                                                   â”‚
â”‚    â–¼                                                                                           â”‚
â”‚  CLIENT                                                                                       â”‚
â”‚    â”‚ HTTP 200 OK + Response                                                                    â”‚
â”‚    â–¼                                                                                           â”‚
â”‚                                                                                               â”‚
â”‚  OBSERVABILITY (Throughout):                                                                  â”‚
â”‚  â€¢ AWS Tracing: All operations                                                                â”‚
â”‚  â€¢ Langfuse: Supervisor decisions, prompts                                                   â”‚
â”‚  â€¢ Metrics: Counters, timings, success/error rates                                            â”‚
â”‚  â€¢ TruLens: Agent evaluation                                                                  â”‚
â”‚  â€¢ Application Logs: All services                                                              â”‚
â”‚                                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Legend

- **ğŸ“Š METRICS**: Performance and operational metrics
- **ğŸ” TRACE**: Distributed tracing information
- **ğŸ“ LOG**: Application logging
- **ğŸ“‹ PROMPT**: Prompt management operations
- **ğŸ’¾ MEMORY**: Memory storage operations
- **ğŸ”„ STATE**: State management operations
- **ğŸŒ HTTP**: HTTP communication
- **âœ“**: Observability checkpoint

---

This comprehensive diagram shows the complete flow including all data transformations, prompt management, observability points, state management, and memory operations throughout the entire request lifecycle.



