# Postman Testing Guide for Multi-Agent Orchestrator

Complete guide for testing AWS API Gateway endpoints and Lambda functions using Postman, including HMAC signature generation for Teams webhook testing.

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Postman Setup](#postman-setup)
4. [Testing API Gateway Endpoints](#testing-api-gateway-endpoints)
5. [Testing Teams Webhook with HMAC](#testing-teams-webhook-with-hmac)
6. [Postman Collection](#postman-collection)
7. [Advanced Testing Scenarios](#advanced-testing-scenarios)
8. [Troubleshooting](#troubleshooting)

---

## Overview

This guide provides step-by-step instructions for testing the Multi-Agent Orchestrator API endpoints using Postman. It covers:

- Setting up Postman environment
- Testing standard API endpoints (`/invocations`, `/ping`)
- Testing Teams webhook endpoint with HMAC signature generation
- Creating and running Postman collections
- Advanced testing scenarios

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/invocations` | POST | Process user query through orchestrator |
| `/api/teams/webhook` | POST | Microsoft Teams webhook endpoint |
| `/health` | GET | Health check endpoint |
| `/metrics` | GET | Get orchestrator metrics |

---

## Prerequisites

### 1. Postman Installation

- **Download Postman**: [postman.com/downloads](https://www.postman.com/downloads/)
- **Install**: Follow installation instructions for your OS
- **Account**: Create free Postman account (optional, for syncing)

### 2. API Gateway Information

- **API Gateway URL**: Your API Gateway invoke URL
  - Format: `https://abc123.execute-api.us-east-1.amazonaws.com/prod`
- **Stage**: API Gateway stage name (e.g., `prod`, `dev`)
- **Region**: AWS region where API Gateway is deployed

### 3. Teams Webhook Secret (for Teams endpoint testing)

- **Webhook Secret**: Security token from Teams webhook configuration
- **Storage**: Keep secret secure (use Postman environment variables)

### 4. Test Data

- Sample queries for testing
- Session IDs (optional)
- Context data (optional)

---

## Postman Setup

### Step 1: Create Postman Environment

1. **Open Postman**
   - Launch Postman application

2. **Create Environment**
   - Click **"Environments"** in left sidebar (or **"Environments"** tab)
   - Click **"+"** button → **"Create Environment"**

3. **Configure Environment Variables**

   | Variable | Initial Value | Current Value | Description |
   |----------|---------------|---------------|-------------|
   | `API_GATEWAY_URL` | `https://abc123.execute-api.us-east-1.amazonaws.com/prod` | (your URL) | Base API Gateway URL |
   | `API_STAGE` | `prod` | (your stage) | API Gateway stage |
   | `TEAMS_WEBHOOK_SECRET` | `your-secret-here` | (your secret) | Teams webhook security token |
   | `SIGNATURE` | (empty) | (auto-generated) | HMAC signature (generated by script) |
   | `SESSION_ID` | `test-session-123` | (auto-generated) | Test session ID |

4. **Save Environment**
   - Click **"Save"**
   - Name: `Multi-Agent Orchestrator`

### Step 2: Select Environment

1. **Environment Selector**
   - Top right corner → Environment dropdown
   - Select `Multi-Agent Orchestrator`

---

## Testing API Gateway Endpoints

### Test 1: Health Check Endpoint

**Purpose**: Verify API Gateway and Lambda are accessible

1. **Create New Request**
   - Click **"New"** → **"HTTP Request"**
   - Name: `Health Check`

2. **Configure Request**
   - **Method**: `GET`
   - **URL**: `{{API_GATEWAY_URL}}/health`

3. **Send Request**
   - Click **"Send"**
   - Expected: `200 OK` with health status

4. **Expected Response**
   ```json
   {
     "status": "healthy",
     "service": "aws-agent-core-orchestrator"
   }
   ```

5. **Add Tests**
   - Click **"Tests"** tab
   - Add test script:
   ```javascript
   pm.test("Status code is 200", function () {
       pm.response.to.have.status(200);
   });
   
   pm.test("Response has status field", function () {
       var jsonData = pm.response.json();
       pm.expect(jsonData).to.have.property('status');
       pm.expect(jsonData.status).to.eql('healthy');
   });
   ```

### Test 2: Process Query Endpoint

**Purpose**: Test the main query processing endpoint

1. **Create New Request**
   - Name: `Process Query - Basic`

2. **Configure Request**
   - **Method**: `POST`
   - **URL**: `{{API_GATEWAY_URL}}/invocations`

3. **Configure Headers**
   ```
   Content-Type: application/json
   Accept: application/json
   ```

4. **Configure Body**
   - Select **"Body"** tab
   - Select **"raw"** → **"JSON"**
   - Add request body:
   ```json
   {
     "query": "What are the total sales for last month?",
     "session_id": "{{SESSION_ID}}",
     "context": {
       "data_type": "structured"
     },
     "agent_preference": null,
     "metadata": {
       "test": true,
       "source": "postman"
     }
   }
   ```

5. **Send Request**
   - Click **"Send"**
   - Wait for response (may take 5-30 seconds)

6. **Expected Response**
   ```json
   {
     "response": "Based on the data analysis, the total sales for last month were $1,234,567...",
     "session_id": "test-session-123",
     "agent_used": "langgraph",
     "confidence": 0.85,
     "sources": [],
     "execution_time": 2.45,
     "metadata": {
       "trace_id": "trace-123",
       "routing_reason": "Query matched structured data pattern"
     }
   }
   ```

7. **Add Tests**
   ```javascript
   pm.test("Status code is 200", function () {
       pm.response.to.have.status(200);
   });
   
   pm.test("Response has required fields", function () {
       var jsonData = pm.response.json();
       pm.expect(jsonData).to.have.property('response');
       pm.expect(jsonData).to.have.property('session_id');
       pm.expect(jsonData).to.have.property('agent_used');
   });
   
   pm.test("Response time is reasonable", function () {
       pm.expect(pm.response.responseTime).to.be.below(30000); // 30 seconds
   });
   ```

### Test 3: Process Query with Agent Parameters

**Purpose**: Test query with AWS Agent Core SDK parameters

1. **Create New Request**
   - Name: `Process Query - With Agent ID`

2. **Configure Request**
   - **Method**: `POST`
   - **URL**: `{{API_GATEWAY_URL}}/invocations`

3. **Configure Body** (same as Test 2)

4. **Send Request**
   - This will trigger direct AWS Agent Core SDK invocation

### Test 4: Metrics Endpoint

**Purpose**: Retrieve orchestrator metrics

1. **Create New Request**
   - Name: `Get Metrics`

2. **Configure Request**
   - **Method**: `GET`
   - **URL**: `{{API_GATEWAY_URL}}/metrics`

3. **Send Request**
   - Click **"Send"**

4. **Expected Response**
   ```json
   {
     "requests": {
       "total": 100,
       "success": 95,
       "error": 5
     },
     "timings": {
       "average": 2.5,
       "p95": 5.0,
       "p99": 10.0
     }
   }
   ```

---

## Testing Teams Webhook with HMAC

### Understanding HMAC Signature

Microsoft Teams signs webhook requests using HMAC SHA256:

```
signature = base64(HMAC-SHA256(webhook_secret, request_body))
```

The signature is sent in the `Authorization` header as:
```
Authorization: Bearer <signature>
```

### Step 1: Generate HMAC Signature

#### Option A: Using Postman Pre-request Script (Recommended)

1. **Create New Request**
   - Name: `Teams Webhook - Valid Request`

2. **Configure Request**
   - **Method**: `POST`
   - **URL**: `{{API_GATEWAY_URL}}/api/teams/webhook`

3. **Add Pre-request Script**
   - Click **"Pre-request Script"** tab
   - Add script:

```javascript
// Teams Webhook HMAC Signature Generation
const crypto = require('crypto');

// Get webhook secret from environment
const webhookSecret = pm.environment.get("TEAMS_WEBHOOK_SECRET");

// Get request body (must be raw string, not parsed JSON)
const requestBody = pm.request.body.raw;

// Generate HMAC SHA256 signature
const signature = crypto
    .createHmac('sha256', webhookSecret)
    .update(requestBody)
    .digest('base64');

// Store signature in environment variable
pm.environment.set("SIGNATURE", signature);

// Set Authorization header
pm.request.headers.add({
    key: 'Authorization',
    value: `Bearer ${signature}`
});

// Also set X-Teams-Signature header (alternative)
pm.request.headers.add({
    key: 'X-Teams-Signature',
    value: signature
});

console.log("Generated signature:", signature);
```

4. **Configure Headers**
   - Headers will be automatically set by pre-request script
   - Ensure these headers exist:
   ```
   Content-Type: application/json
   Authorization: Bearer {{SIGNATURE}}
   ```

5. **Configure Body**
   - Select **"Body"** tab
   - Select **"raw"** → **"JSON"**
   - Add Teams webhook payload:

```json
{
  "text": "What are the total sales for Q4 2024?",
  "from": {
    "id": "29:1test-user-id",
    "name": "John Doe"
  },
  "channel": {
    "id": "19:test-channel-id@thread.skype",
    "name": "General"
  },
  "tenant": {
    "id": "test-tenant-id"
  }
}
```

6. **Send Request**
   - Click **"Send"**
   - Signature will be automatically generated

#### Option B: Using Python Script (External)

Create a Python script to generate signature:

```python
import hmac
import hashlib
import base64
import json

# Webhook secret from Teams
webhook_secret = "your-webhook-secret-here"

# Request body (must match exactly what you send)
request_body = json.dumps({
    "text": "What are the total sales?",
    "from": {
        "id": "29:1test-user-id",
        "name": "Test User"
    },
    "channel": {
        "id": "19:test-channel-id",
        "name": "General"
    },
    "tenant": {
        "id": "test-tenant-id"
    }
})

# Generate HMAC SHA256 signature
signature = base64.b64encode(
    hmac.new(
        webhook_secret.encode("utf-8"),
        request_body.encode("utf-8"),
        hashlib.sha256
    ).digest()
).decode("utf-8")

print(f"Signature: {signature}")
print(f"Authorization Header: Bearer {signature}")
print(f"\nRequest Body:\n{request_body}")
```

**Usage:**
```bash
python generate_signature.py
# Copy the signature and use in Postman Authorization header
```

### Step 2: Test Valid Teams Webhook Request

1. **Use Request from Step 1**
   - Ensure pre-request script is configured
   - Body contains valid Teams webhook payload

2. **Send Request**
   - Click **"Send"**
   - Wait for response

3. **Expected Response (200 OK)**
   ```json
   {
     "text": "Based on the data analysis, the total sales for Q4 2024 were $5,678,901..."
   }
   ```

4. **Add Tests**
   ```javascript
   pm.test("Status code is 200", function () {
       pm.response.to.have.status(200);
   });
   
   pm.test("Response has text field", function () {
       var jsonData = pm.response.json();
       pm.expect(jsonData).to.have.property('text');
       pm.expect(jsonData.text).to.be.a('string');
   });
   
   pm.test("Response time is less than 10 seconds", function () {
       pm.expect(pm.response.responseTime).to.be.below(10000);
   });
   ```

### Step 3: Test Invalid Signature

**Purpose**: Verify HMAC verification rejects invalid signatures

1. **Create New Request**
   - Name: `Teams Webhook - Invalid Signature`

2. **Configure Request**
   - **Method**: `POST`
   - **URL**: `{{API_GATEWAY_URL}}/api/teams/webhook`

3. **Configure Headers**
   ```
   Content-Type: application/json
   Authorization: Bearer invalid-signature-12345
   ```

4. **Configure Body** (same as valid request)

5. **Send Request**
   - Click **"Send"**

6. **Expected Response (401 Unauthorized)**
   ```json
   {
     "error": "Invalid signature",
     "error_code": "UNAUTHORIZED",
     "details": {}
   }
   ```

7. **Add Tests**
   ```javascript
   pm.test("Status code is 401", function () {
       pm.response.to.have.status(401);
   });
   
   pm.test("Error indicates unauthorized", function () {
       var jsonData = pm.response.json();
       pm.expect(jsonData.error_code).to.eql('UNAUTHORIZED');
   });
   ```

### Step 4: Test Missing Signature

1. **Create New Request**
   - Name: `Teams Webhook - Missing Signature`

2. **Configure Request**
   - **Method**: `POST`
   - **URL**: `{{API_GATEWAY_URL}}/api/teams/webhook`

3. **Configure Headers** (NO Authorization header)
   ```
   Content-Type: application/json
   ```

4. **Configure Body** (same as valid request)

5. **Send Request**
   - Click **"Send"**

6. **Expected Response**
   - If secret is configured: `401 Unauthorized`
   - If secret is not configured: `200 OK` (verification skipped)

### Step 5: Test Empty Message

1. **Create New Request**
   - Name: `Teams Webhook - Empty Message`

2. **Use Pre-request Script** (from Step 1)

3. **Configure Body**
   ```json
   {
     "text": "",
     "from": {
       "id": "29:1test-user-id",
       "name": "Test User"
     },
     "channel": {
       "id": "19:test-channel-id",
       "name": "General"
     }
   }
   ```

4. **Send Request**

5. **Expected Response (200 OK)**
   ```json
   {
     "text": "Please provide a query or question."
   }
   ```

---

## Postman Collection

### Create Collection

1. **Create New Collection**
   - Postman → **"Collections"** → **"+"** → **"New Collection"**
   - Name: `Multi-Agent Orchestrator API`

2. **Add Folder Structure**
   - **Health & Metrics**
     - Health Check
     - Get Metrics
   - **Query Processing**
     - Process Query - Basic
     - Process Query - With Agent ID
     - Process Query - With Context
   - **Teams Webhook**
     - Teams Webhook - Valid Request
     - Teams Webhook - Invalid Signature
     - Teams Webhook - Missing Signature
     - Teams Webhook - Empty Message

### Collection Variables

1. **Set Collection Variables**
   - Collection → **"Variables"** tab
   - Add variables:
     | Variable | Initial Value | Current Value |
     |----------|---------------|---------------|
     | `base_url` | `https://abc123.execute-api.us-east-1.amazonaws.com/prod` | (your URL) |
     | `webhook_secret` | `your-secret` | (your secret) |

2. **Use in Requests**
   - Use `{{base_url}}` instead of `{{API_GATEWAY_URL}}`

### Collection-Level Scripts

1. **Pre-request Script** (Collection level)
   - Collection → **"Pre-request Script"** tab
   - Add common setup:

```javascript
// Set default headers
pm.request.headers.add({
    key: 'Content-Type',
    value: 'application/json'
});

// Generate session ID if not set
if (!pm.environment.get("SESSION_ID")) {
    pm.environment.set("SESSION_ID", "postman-" + Date.now());
}
```

2. **Tests** (Collection level)
   - Collection → **"Tests"** tab
   - Add common tests:

```javascript
// Log response time
console.log("Response time: " + pm.response.responseTime + "ms");

// Check for errors in response
if (pm.response.code >= 400) {
    console.log("Error response:", pm.response.text());
}
```

### Export Collection

1. **Export Collection**
   - Collection → **"..."** → **"Export"**
   - Select **"Collection v2.1"**
   - Click **"Export"**
   - Save as `Multi-Agent-Orchestrator.postman_collection.json`

### Import Collection

1. **Import Collection**
   - Postman → **"Import"** button
   - Select collection JSON file
   - Click **"Import"**

---

## Advanced Testing Scenarios

### Scenario 1: Load Testing

**Purpose**: Test API performance under load

1. **Use Postman Runner**
   - Collection → **"..."** → **"Run collection"**

2. **Configure Run**
   - **Iterations**: 10-100
   - **Delay**: 1000ms between requests
   - **Data File**: (optional) CSV with test data

3. **Run Collection**
   - Click **"Run"**
   - Monitor response times and errors

### Scenario 2: Error Handling

**Test Cases:**

1. **Invalid JSON**
   - Send malformed JSON
   - Expected: `400 Bad Request`

2. **Missing Required Fields**
   - Send request without `query` field
   - Expected: `400 Bad Request` with error message

3. **Invalid Agent ID**
   - Send request with invalid `agent_id`
   - Expected: `500 Internal Server Error` or appropriate error

4. **Timeout Scenario**
   - Send complex query that may timeout
   - Expected: `504 Gateway Timeout` or `500 Internal Server Error`

### Scenario 3: Session Management

1. **Create Session**
   - Send query with new `session_id`
   - Verify session is created

2. **Continue Session**
   - Send follow-up query with same `session_id`
   - Verify context is maintained

3. **Session Expiry**
   - Wait for session to expire (if TTL configured)
   - Send query with expired session
   - Verify new session is created

### Scenario 4: Agent Routing

1. **Test Agent Preference**
   - Send query with `agent_preference: "market_segment"`
   - Verify correct agent is used

2. **Test Automatic Routing**
   - Send query without preference
   - Verify LangGraph routes correctly

3. **Test Multiple Agents**
   - Send query requiring multiple agents
   - Verify combined response

---

## Complete Postman Collection JSON

Here's a complete Postman collection you can import:

```json
{
  "info": {
    "name": "Multi-Agent Orchestrator API",
    "description": "Complete API collection for Multi-Agent Orchestrator",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "https://abc123.execute-api.us-east-1.amazonaws.com/prod",
      "type": "string"
    },
    {
      "key": "webhook_secret",
      "value": "your-webhook-secret-here",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Health Check",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/health",
          "host": ["{{base_url}}"],
          "path": ["health"]
        }
      },
      "response": []
    },
    {
      "name": "Process Query",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"query\": \"What are the total sales?\",\n  \"session_id\": \"test-123\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/invocations",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "query"]
        }
      },
      "response": []
    },
    {
      "name": "Teams Webhook",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const crypto = require('crypto');",
              "const secret = pm.collectionVariables.get('webhook_secret');",
              "const body = pm.request.body.raw;",
              "const signature = crypto.createHmac('sha256', secret).update(body).digest('base64');",
              "pm.request.headers.add({key: 'Authorization', value: 'Bearer ' + signature});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"What are sales?\",\n  \"from\": {\"id\": \"29:1\", \"name\": \"Test\"},\n  \"channel\": {\"id\": \"19:1\", \"name\": \"General\"}\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/teams/webhook",
          "host": ["{{base_url}}"],
          "path": ["api", "teams", "webhook"]
        }
      },
      "response": []
    }
  ]
}
```

**To use:**
1. Copy the JSON above
2. Postman → **"Import"** → **"Raw text"**
3. Paste JSON → Click **"Import"**
4. Update `base_url` and `webhook_secret` variables

---

## Troubleshooting

### Issue 1: HMAC Signature Verification Fails

**Symptoms:**
- Postman shows 401 Unauthorized
- Lambda logs show "Invalid signature"

**Solutions:**

1. **Verify Secret Matches**
   - Check `TEAMS_WEBHOOK_SECRET` in Postman environment
   - Ensure it matches Lambda environment variable

2. **Check Body Format**
   - Ensure body is raw JSON string (not parsed)
   - No extra whitespace or formatting
   - Exact match between signature generation and request

3. **Verify Signature Generation**
   - Check pre-request script logs
   - Compare with Python script output
   - Ensure UTF-8 encoding

4. **Test Signature Manually**
   ```python
   # Test script
   import hmac, hashlib, base64, json
   
   secret = "your-secret"
   body = '{"text":"test"}'
   
   sig = base64.b64encode(
       hmac.new(secret.encode(), body.encode(), hashlib.sha256).digest()
   ).decode()
   
   print(f"Signature: {sig}")
   ```

### Issue 2: Request Timeout

**Symptoms:**
- Postman shows timeout error
- No response received

**Solutions:**

1. **Increase Postman Timeout**
   - Postman Settings → **"General"**
   - **Request timeout**: Increase to 60 seconds

2. **Check API Gateway Timeout**
   - API Gateway has 30-second timeout
   - Ensure Lambda completes within this time

3. **Check Lambda Timeout**
   - Lambda timeout should be < API Gateway timeout
   - Check CloudWatch logs for Lambda execution time

### Issue 3: CORS Errors

**Symptoms:**
- Browser console shows CORS errors
- Preflight OPTIONS requests fail

**Solutions:**

1. **Verify CORS Configuration**
   - API Gateway → Your API → CORS
   - Ensure methods and headers are configured

2. **Test with Postman (not browser)**
   - Postman doesn't enforce CORS
   - Use Postman for API testing

### Issue 4: Environment Variables Not Working

**Symptoms:**
- Variables show as `{{VARIABLE}}` instead of values
- Requests fail with invalid URL

**Solutions:**

1. **Select Correct Environment**
   - Top right → Environment dropdown
   - Select your environment

2. **Check Variable Names**
   - Case-sensitive
   - Use exact variable names

3. **Verify Variable Values**
   - Environments → Edit environment
   - Check Initial Value and Current Value

### Issue 5: Pre-request Script Not Executing

**Symptoms:**
- HMAC signature not generated
- Headers not set

**Solutions:**

1. **Check Script Syntax**
   - Verify JavaScript syntax is correct
   - Check Postman console for errors

2. **Enable Console**
   - Postman → View → Show Postman Console
   - Check for script errors

3. **Test Script Manually**
   - Copy script to Node.js
   - Test execution

---

## Best Practices

### 1. Environment Management

- ✅ **Use environments** for different stages (dev, staging, prod)
- ✅ **Never commit secrets** to version control
- ✅ **Use collection variables** for shared values
- ✅ **Document variables** with descriptions

### 2. Request Organization

- ✅ **Use folders** to organize requests
- ✅ **Name requests** descriptively
- ✅ **Add descriptions** to requests
- ✅ **Use examples** for documentation

### 3. Testing

- ✅ **Add tests** to all requests
- ✅ **Use test scripts** for validation
- ✅ **Run collections** for regression testing
- ✅ **Monitor response times**

### 4. Security

- ✅ **Store secrets** in environment variables
- ✅ **Use pre-request scripts** for signature generation
- ✅ **Never hardcode** secrets in requests
- ✅ **Rotate secrets** periodically

### 5. Documentation

- ✅ **Add descriptions** to requests
- ✅ **Document expected responses**
- ✅ **Include examples** in collection
- ✅ **Maintain changelog** for API changes

---

## Quick Reference

### Common Postman Shortcuts

- **Send Request**: `Ctrl+Enter` (Windows/Linux) or `Cmd+Enter` (Mac)
- **Save Request**: `Ctrl+S`
- **New Request**: `Ctrl+N`
- **Show Console**: `Ctrl+Alt+C`

### Environment Variable Syntax

```
{{VARIABLE_NAME}}
```

### Collection Variable Syntax

```
{{$variableName}}
```

### Dynamic Variables

Postman provides dynamic variables:
- `{{$timestamp}}` - Current timestamp
- `{{$randomInt}}` - Random integer
- `{{$guid}}` - GUID

### Example Usage

```json
{
  "session_id": "session-{{$timestamp}}",
  "request_id": "req-{{$guid}}"
}
```

---

## Summary

This guide covers:

1. ✅ **Complete Postman setup** with environments
2. ✅ **Testing all API endpoints** (query, health, metrics)
3. ✅ **HMAC signature generation** for Teams webhook
4. ✅ **Postman collection** creation and management
5. ✅ **Advanced testing scenarios** and error handling
6. ✅ **Troubleshooting** common issues

### Next Steps

1. Import the provided Postman collection
2. Configure environment variables
3. Test all endpoints
4. Create custom test scenarios
5. Set up automated testing with Postman CLI

---

**Last Updated**: 2024  
**Maintained By**: Multi-Agent Orchestrator Team
